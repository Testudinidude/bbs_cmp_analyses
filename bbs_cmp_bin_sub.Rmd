---
title: "Breeding Bird Surveys - Cleveland Metroparks (new and improved, with landscape covariates!)"
author: "Nathan W. Byer"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 6
    fig_height: 4
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.width = "100%")

options(width=1200)
```

```{r, echo = FALSE,warning=FALSE,error=FALSE,message=FALSE}

#library(BiodiversityR)
library(dplyr)
library(tidyverse)
library(vegan)
library(caret)
library(lubridate)
library(spOccupancy)
library(vegan)
library(raster)
library(dismo)
library(terra)
library(sp)
library(rgdal)
library(gstat)
library(broom)
library(shiny)
library(sp)
library(ggplot2)
library(RColorBrewer)
library(rgdal)
library(broom)
library(AICcmodavg)
library(indicspecies)
library(lme4)
library(MASS)
library(cooccur)
library(igraph)
library(visNetwork)
library(ggsci)
library(readxl)


#options(repos = c(
#    fawda123 = 'https://fawda123.r-universe.dev',
#    CRAN = 'https://cloud.r-project.org'))

# Install ggord
#install.packages('ggord')
library(ggord)

#code from here: https://www.r-bloggers.com/2011/11/outersect-the-opposite-of-rs-intersect-function/#:~:text=setdiff()%20produces%20all%20elements,vector%20(i.e.%20is%20asymmetric).
outersect <- function(x, y, ...) {
  big.vec <- c(x, y, ...)
  duplicates <- big.vec[duplicated(big.vec)]
  setdiff(big.vec, unique(duplicates))
}

lda_birdcomm<-readRDS("G:/NaturalResources/Byer/datasets/BBS/lda_birdcomm.rds")

```

# The dataset

Tim Krynak, Erik Shaffer, Jen Brumfield, and other Cleveland Metroparks and affiliated colleagues conducted Breeding Bird Surveys (BBS) at a total of 211 routes between 2017 and 2021. 164 of these routes overlapped with long-term vegetation monitoring efforts through the Cleveland Metroparks Plant Community Assessment Program (PCAP). This provided an excellent opportunity to explore the potential relationships between vegetative composition, landscape structure, and breeding bird ecology and community composition.

# Initial processing

First, we just read in the full BBS dataset. For our purposes, we will remove any BBS observations not paired with PCAP plots. We can also visualize the distribution of survey effort through time.

```{r}
CMP_bbs_pcap_join<-read.csv("G:/NaturalResources/Byer/datasets/BBS/CMP_bbs_pcapjoin_1221covars.csv",header=T)
CMP_bbs_pcap_join_pcaponly<-CMP_bbs_pcap_join[!is.na(CMP_bbs_pcap_join$Plot.ID),]

datetime<-strptime(CMP_bbs_pcap_join_pcaponly$survey_cre,format="%m/%d/%Y %H:%M")
hist(datetime,breaks="months")

pcap_1styear_landscape<-read.csv("G:/NaturalResources/Byer/datasets/BBS/pcap_4yr_landscape_variables_revLDI.csv",header=T)


```

Next, we need to start grouping this dataset for downsteram analysis. This involves summarizing counts of each species for each plot. We also replace any NA values in the data frame with zeroes - this will be important for downstream applications, as we want to distinguish between unobserved species at a plot and check (typically coded 0s) and checks that were "skipped" (NAs).

```{r,warning=FALSE,error=FALSE,message=FALSE}
CMP_bbs_pcap_join_pcaponly_pcapsum<-CMP_bbs_pcap_join_pcaponly %>% 
  group_by(simp_plot, reservatio,community,species_4_) %>%
  summarise(n=n(),longitude=mean(xcoord), latitude=mean(ycoord),vibifq=mean(as.numeric(vibi_fq_nt)),carex=mean(as.numeric(carex)),
            dicot=mean(as.numeric(dicot)),shade=mean(as.numeric(shade)),shrub=mean(as.numeric(shrub)),
            hydro=mean(as.numeric(hydro)),svp=mean(as.numeric(svp)),
            fqi=mean(as.numeric(fqai)),
            sens_rel=mean(as.numeric(sens)),
            tol_rel=mean(as.numeric(tol)),
            developed=mean(as.numeric(dev)),
            ldi=mean(as.numeric(ldi_3k)),
            small_tree=mean(as.numeric(small_tree)),
            subcanopy_dens=mean(as.numeric(sub_dens)),
            subcanopy_dom=mean(as.numeric(sub_dom)),
            subcanopy_iv=mean(as.numeric(sub_iv)),
            canopy_dens=mean(as.numeric(can_dens)),
            canopy_dom=mean(as.numeric(can_dom)),
            canopy_iv=mean(as.numeric(can_iv)),
            shrub=mean(as.numeric(shrub)),
            monocots=mean(as.numeric(monocots)),
            perc_open=mean(as.numeric(percent_op)),
            slope=mean(slope),
            aspect=mean(aspect),
            twi=mean(twi)
            ) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0)

names(pcap_1styear_landscape)[names(pcap_1styear_landscape) == 'site.name'] <- 'simp_plot'


CMP_bbs_pcap_join_pcaponly_pcapsum_landscape<-left_join(x = CMP_bbs_pcap_join_pcaponly_pcapsum,y = pcap_1styear_landscape,by="simp_plot")

CMP_bbs_pcap_join_pcaponly_pcapsum<-column_to_rownames(CMP_bbs_pcap_join_pcaponly_pcapsum_landscape,var="simp_plot")

```

This is a pretty unwieldly dataset at present - we have 164 rows (representing our BBS/PCAP plots) and 131 columns. Out of those 131 columns, 103 are unique species (designated with four-letter codes), so most of the first 27 covariates are essentially our "predictors" - in this case, our PCAP data.

Let's do a bit more processing on this dataset to get it in shape for downstream analyses. First, we will separate out our bird community data.

```{r,warning=FALSE,error=FALSE,message=FALSE}

birdcomm<-CMP_bbs_pcap_join_pcaponly_pcapsum[,30:(132)]

birdcomm[is.na(birdcomm)] <- 0

```

Next, we separate out our PCAP data.

```{r,warning=FALSE,error=FALSE,message=FALSE}
vegecomm<-CMP_bbs_pcap_join_pcaponly_pcapsum[,c(5:14,17:25)]

```

Finally, we will separate out the 1st year landscape covariates. As a quick note, these will not be *strictly* comparable with the 2nd survey landscape covariates, but should be pretty close (\~5 years is likely not enough for substantial land cover change).

```{r,warning=FALSE,error=FALSE,message=FALSE}
landcomm<-CMP_bbs_pcap_join_pcaponly_pcapsum[,c(15,16,26,27,28,149,158,159)]

landcomm[is.na(landcomm)] <- 0


```

Since we are using the PCAP dataset as predictors here, we should likely check for correlations between these covariates. I have selected a (semi-)arbitrary cut-off of 0.6 to identify covariates as correlated; we then drop any covariates that are likely redundant.

```{r,warning=FALSE,error=FALSE,message=FALSE}

vegecomm_cor<-cor(vegecomm)

set.seed(12345)
corvar<-findCorrelation(vegecomm_cor,cutoff=0.6)

vegecomm_drop<-vegecomm[,-corvar]
```

We can also check for correlations between the landscape covariates.

```{r,warning=FALSE,error=FALSE,message=FALSE}
cols<-seq(1,8,1)

landcomm[,cols] = apply(landcomm[,cols], 2, function(x) as.numeric(as.character(x)))

landcomm_cor<-cor(landcomm)

set.seed(12345)
corvar_land<-findCorrelation(landcomm_cor,cutoff=0.6)

landcomm_drop<-landcomm[,-corvar_land]

```

We can then check correlations between PCAP and landscape covariates.

```{r,warning=FALSE,error=FALSE,message=FALSE}

landvegcomm_drop<-cbind(vegecomm_drop,landcomm_drop)

landvegcomm_drop_cor<-cor(landvegcomm_drop)

set.seed(12345)
corvar_landveg<-findCorrelation(landvegcomm_drop_cor,cutoff=0.6)

```

No covariates were overly correlated in this dataset, so we can proceed.

Now, we have:

a)  a vegecomm dataset - which representing PCAP measurements for each of the 164 BBS/PCAP plots.
b)  a birdcomm dataset - representing presence/absence of each bird species for each survey in each plot.
c)  a landcomm dataset - representing landscape covariates associated with these PCAP plots.

Note that we are not explicitly considering differences in bird counts (or occupancy, or detectability) through time at this point - we will get to that later. For now, we just want to explore broad associations between these three datasets!

Note as of 6/13/2022 - we will also want to only work with only binary data.

# Community analyses

When working with datasets like these, we first have to acknowledge that these datasets are multivariate - with many possible predictor covariates (for example, plot-level characteristics) and many possible response covariates (for example, presence/absence of species in a plot). Fortunately, community ecology as a field has developed a number of standard approaches for exploring multivariate datasets, of which the most common is (arguably!) ordination. In essence, ordination techniques try to shrink down highly multidimensional datasets into a more manageable number of dimensions - often just a handful (and for initial plotting, typically just two). There are many, many possible ordination tools available for exploring community ecological datasets, and we will explore a few.

## unconstrained ordination

In this section, we will be exploring ways of exploring the bird dataset on its own - basically, without any predictors.

First, we must reclassify our bird community data onto a binary scale - ranging from 0 (no detection) to 1 (detection).

We also set our color palette for residency status, so that Red = resident, Green = short-distance migrant, and Blue = neotropical migrant.

```{r,warning=FALSE,error=FALSE,message=FALSE}


birdcomm_bin<-birdcomm

birdcomm_bin<- birdcomm_bin %>% mutate_if(is.numeric, ~1 * (. >= 1))

BBSMigrants<-read.csv("G:/NaturalResources/Byer/datasets/BBS/BBS Migants.csv",header=T)

BBSMigrants_sub<-BBSMigrants[BBSMigrants$SpeciesCode %in% colnames(birdcomm_bin),]

BBSMigrants_sub_2<-BBSMigrants_sub[order(BBSMigrants_sub$SpeciesCode),]

Residency<-BBSMigrants_sub_2$Residency

color_resid<-Residency

color_resid[color_resid %in% "NE"]<-"#56B4E9"

color_resid[color_resid %in% "M"]<-"#009E73"

color_resid[color_resid %in% "R"]<-"#E69F00" 

BBSMigrants_sub$color_resid<-color_resid


```

One of the most common approaches for unconstrained ordination is called Principal Components Analysis (PCA). I have illustrated vegan's rda() function (which we will use a bit more below!). Out of the available options, I find rda() to be much easier to use, so I tend to use it preferentially. Here is a plot with convex hulls and points colored by reservation.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}
reserv<-factor(toupper(CMP_bbs_pcap_join_pcaponly_pcapsum$reservatio))
colpal_reserv<-rainbow(length(levels(reserv)))

p_unconc<-rda(birdcomm_bin,scale=T)

PCAscores <- scores(p_unconc, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("site") 

PCAvect <- scores(p_unconc, display = "species") %>% 
  as.data.frame()

reservplot<-ordiplot(p_unconc,scaling=3,type="n")
points(reservplot, "sites",pch=21, col=colpal_reserv[reserv])


ordihull(reservplot,groups = reserv, col=colpal_reserv, lwd=3)
title("PCA (vegan rda version)")
legend(x="right", legend=levels(reserv), col=colpal_reserv,pch = 1,cex=0.5) 

```

while a bit hard to interpret, plots within Rocky River (RR) seem to be the most variable - and it might be that we see higher diversity in that area. We will see as we proceed if that is true.

### metric multidimensional scaling (Principal Coordinates Analysis)

You can think of this as a distance-based analog to PCA. In this case, since we are using Bray-Curtis distances on binary data (presence/absence), this is equivalent to Sorensen's index.

```{r,warning=FALSE,error=FALSE,message=FALSE, echo = FALSE}
bird_pcoa<-capscale(birdcomm_bin~1,distance="bray")

plot(bird_pcoa,type="n",main="PCoA") 

text(bird_pcoa,display="species",col=BBSMigrants_sub$color_resid,cex=0.6) 

points(bird_pcoa,display="sites",pch=16) #adds filled circles for sites

```


## constrained

Whereas the ordination approaches above were focused on unconstrained ordination - in this case, exploring how species are arranged between sample sites - there is an entire suite of approaches that address how environmental gradients shape community assemblages among sample sites. These are called **constrained** ordination approaches. I am personally a huge proponent of redundancy analysis (RDA) as a flexible constrained ordination approach. Taken from the GUSTA ME tutorial on RDA:

"*RDA can also be considered a constrained version of principal components analysis (PCA), wherein canonical axes - built from linear combinations of response variables - must also be linear combinations of the explanatory variables (i.e. fitted by [multiple linear regression]). The RDA approach generates one ordination in the space defined by the matrix of response variables and another in the space defined by the matrix of explanatory variables.*"

So, in essence, the ordination plot produced will depict an optimal arrangement of environmental axes (RDA1, 2, etc.) that maximally explains variation in the species dataset.

We are going to use stepwise selection to explore which PCAP covariates most explain plot-level differences.

```{r}

p<-rda(birdcomm_bin~.,vegecomm_drop,scale=T)
fit<-envfit(p,vegecomm_drop,scale=T)
intersetcor(p)

ggord(p,  xlim=c(-1.25,1),ylim = c(-1, 1),txt=4,arrow=TRUE,ptslab=TRUE,addsize=3, size =4,addcol = color_resid)

constrained_eig <- p$CCA$eig/p$tot.chi*100
unconstrained_eig <- p$CA$eig/p$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')


p_0<-rda(birdcomm_bin~1,vegecomm_drop,scale=T)
p_1<-rda(birdcomm_bin~.,vegecomm_drop,scale=T)


ggord(p_1)
set.seed(12345)
p_step<- ordistep(p_0, scope = formula(p_1),trace=F)
p_step

anova(p_step)
anova(p_step,by="term")
anova(p_step,by="axis")

pcapplot<-ordiplot(p_step,scaling=3,type="n")
points(pcapplot, "sites",pch=3, col=colpal_reserv[reserv])

ordihull(pcapplot,groups = reserv, col=colpal_reserv, lwd=3)
title("PCA (vegan rda version)")
legend(x="right", legend=levels(reserv), col=colpal_reserv,pch = 3,cex=0.5)

ggord(p_step,  xlim=c(-1.25,1.25),ylim = c(-0.5, 1),txt=4,arrow=TRUE,ptslab=TRUE,addsize=3, size =4,addcol = color_resid)

```

So this tells us that the most explanatory group of PCAP covariates is relative cover of tolerant plants (tol_rel), cover of dicots, cover of seedless vascular plants (svp), and cover of sedges (cyper). Rather conveniently, the relative cover of dicots, seedless vascular plants, and sedges is negatively associated with the relative cover of tolerant plant species.

As a quick caveat, these four variables only explain about 7.3% of the variation, as seen here (red is our environmental axes, black is our unconstrained axes):

```{r}
constrained_eig <- p_step$CCA$eig/p_step$tot.chi*100
unconstrained_eig <- p_step$CA$eig/p_step$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')
```

This is not that terribly uncommon for redundancy analyses - It is often difficult to find environmental gradients that explain all of the variance in large datasets like ours. Biologically, we likely do not necessarily expect that a single environmental gradient alone drives all of the variation in bird presence/absence, and intuitively know that we also have to worry about observer effects, weather, and other unmeasured characteristics. Regardless of any of the above, the ordination is significant - as are the relationships with these covariates, so we can safely say that nearly 10% of the variation in our bird species dataset is explainable by these 4 PCAP covariates!

We can also explore just the landscape covariate associations:

```{r}

landcomm_drop$developed.x<-landcomm$developed.x
landcomm_drop<-landcomm_drop[,-5]

p_land<-rda(birdcomm_bin~.,landcomm_drop,scale=T)
fit<-envfit(p_land,landcomm_drop,scale=T)

intersetcor(p_land)

ggord(p_land,  xlim=c(-1.25,1),ylim = c(-1, 1),txt=4,arrow=TRUE,ptslab=TRUE,addsize=3, size =4,addcol = color_resid)

constrained_eig <- p$CCA$eig/p$tot.chi*100
unconstrained_eig <- p$CA$eig/p$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')


p_land_0<-rda(birdcomm_bin~1,landcomm_drop,scale=T)
p_land_1<-rda(birdcomm_bin~.,landcomm_drop,scale=T)

set.seed(12345)
p_land_step<- ordistep(p_land_0, scope = formula(p_land_1),trace=F)

anova(p_land_step)
anova(p_land_step,by="term")
anova(p_land_step,by="axis")
ordiplot(p_land_step,scaling=3)

constrained_eig <- p_land_step$CCA$eig/p_land_step$tot.chi*100
unconstrained_eig <- p_land_step$CA$eig/p_land_step$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')

```

And now for the vegetation and land cover dataset:

```{r,warning=FALSE,message=FALSE}

landvegcomm_drop<-cbind(vegecomm_drop,landcomm_drop)

landvegcomm_drop_cor<-cor(landvegcomm_drop)

set.seed(12345)
corvar_landveg<-findCorrelation(landvegcomm_drop_cor,cutoff=0.6)

BBSMigrants<-read.csv("G:/NaturalResources/Byer/datasets/BBS/BBS Migants.csv",header=T)

BBSMigrants_sub<-BBSMigrants[BBSMigrants$SpeciesCode %in% colnames(birdcomm_bin),]

birdcomm_bin_t<-t(birdcomm_bin)

BBSMigrants_sub_reorder<-BBSMigrants_sub[match(rownames(birdcomm_bin_t), BBSMigrants_sub$SpeciesCode),]
color_resid<-BBSMigrants_sub_reorder$Residency

color_resid[color_resid %in% "NE"]<-"#56B4E9"

color_resid[color_resid %in% "M"]<-"#009E73"

color_resid[color_resid %in% "R"]<-"#E69F00" 

p_landveg<-rda(birdcomm_bin~.,landvegcomm_drop,scale=T)
fit_landveg<-envfit(p_landveg,landvegcomm_drop,scale=T)

intersetcor(p_landveg)

constrained_eig <- p_landveg$CCA$eig/p_landveg$tot.chi*100
unconstrained_eig <- p_landveg$CA$eig/p_landveg$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')


ggord(p_landveg,  xlim=c(-1.25,1.25),ylim = c(-1, 0.75),txt=4,arrow=TRUE,ptslab=TRUE,addsize=4, size =4,addcol = color_resid)

intersetcor(p_landveg)

p_landveg_0<-rda(birdcomm_bin~1,landvegcomm_drop,scale=T)
p_landveg_1<-rda(birdcomm_bin~.,landvegcomm_drop,scale=T)

set.seed(12345)
p_landveg_step<- ordistep(p_landveg_0, scope = formula(p_landveg_1),trace = F)
p_landveg_step


anova(p_landveg_step)
anova(p_landveg_step,by="term")
anova(p_landveg_step,by="axis")
ordiplot(p_landveg_step,scaling=3)

ggord(p_landveg_step,  xlim=c(-1.25,1.25),ylim = c(-1, 0.75),txt=4,arrow=TRUE,ptslab=TRUE,addsize=4, size =4,addcol = color_resid)



constrained_eig <- p_landveg_step$CCA$eig/p_landveg_step$tot.chi*100
unconstrained_eig <- p_landveg_step$CA$eig/p_landveg_step$tot.chi*100
expl_var <- c(constrained_eig, unconstrained_eig)
barplot (expl_var[1:20], col = c(rep ('red', length (constrained_eig)), rep ('black', length (unconstrained_eig))),
         las = 2, ylab = '% variation')

```

Some interesting things are going on here. RDA1 primarily captures both plot-scale and landscape-scale indicators of disturbance - namely, relative cover of tolerant plant species (plot level) and landscape development index (at a landscape-level) contrasted with indicators of less disturbance - namely, further distances to developed land, more seedless vascular plants, more cyperaceae, and more dicots. This one axis explains upwards of 5% of variation - so we are doing pretty well in that regard. Across all seven axes, we are approaching about 11% explained variance. In addition, stepwise selection basically confirms variable selection for the land cover and vegetation datasets run separately - the same variables included in those best-supported model statements are in this full model.

<<<<<<<< HEAD:bbs_cmp_bin_sub.Rmd
========
We can also explore bird species most significantly associated with our constrained ordination axes, too. We will focus on the full (land cover and vegetation) ordination.

```{r,warning=FALSE,error=FALSE,message=FALSE}
# envfit() takes the output of metaMDS() and the species matrix you created
fitconcrda <- envfit(p_landveg_step, birdcomm_bin, perm = 999) 

# extract p-values for each species
fitconcrda_pvals <- fitconcrda$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".")

# extract coordinates for species, only keep species with p-val = 0.001
fitconcrda_spp <- fitconcrda %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., fitconcrda_pvals, by = "species") %>% 
  filter(pvals == 0.001)


```

OK - this is getting towards our main analytical goals! Let's sort by scores for that first environmental axis and plot these in order:

```{r,fig.height=12}


BBSMigrants_sub_sig<-BBSMigrants_sub[BBSMigrants_sub$SpeciesCode %in% fitconcrda_spp$species,]

BBSMigrants_sub_sig_reorder<-BBSMigrants_sub_sig[order(BBSMigrants_sub_sig$SpeciesCode),]

fitconcrda_spp_reorder<-fitconcrda_spp[order(fitconcrda_spp$species),]

fitconcrda_spp_join<-cbind(fitconcrda_spp_reorder,BBSMigrants_sub_sig_reorder)


fitconcrda_spp_order<-fitconcrda_spp_join[order(fitconcrda_spp_join$RDA1),]
fitconcrda_spp_order$species<-factor(fitconcrda_spp_order$species,levels=fitconcrda_spp_order$species)

fitconcrda_spp_order$color_resid[fitconcrda_spp_order$Residency %in% "NE"]<-"#56B4E9"

fitconcrda_spp_order$color_resid[fitconcrda_spp_order$Residency %in% "M"]<-"#009E73"

fitconcrda_spp_order$color_resid[fitconcrda_spp_order$Residency %in% "R"]<-"#E69F00" 



color_sub<-fitconcrda_spp_order$color_resid

ggplot(aes(x=RDA1,y=species),data=fitconcrda_spp_order)+geom_point()+theme_classic(base_size=18)+theme(axis.text.y = element_text(colour = color_sub))

```

This is a pretty neat plot - Acadian Flycatcher, Scarlet Tanager, Eastern Wood-Pewee, White-breasted Nuthatch, Hooded Warbler, Red-Eyed Vireo, Dark-Eyed Junco, Wood Thrush, Hairy Woodpeckers, and Lousiana Water-Thrush all appear to be associated with higher sedge, seedless vascular plant, and dicot cover and lower cover of tolerant plants. In contrast, Yellow Warblers, Orchard Orioles, Red-Winged Blackbirds, European Starlings, Warbling Vireos, Song Sparrows, Grey Catbirds, Tree Swallows, Mourning Doves, and Cedar Waxwings are all associated with more tolerant plants. In addition, virtually all of our more tolerant vegetation-associated species are short-distance migrants, whereas the less tolerant vegetation-associated species are mostly neotropical migrants.

### constrained - sites

While we have already explored environmental associations, we might also want to know what species are most differentiated between reservations. We will then use similar code to that used above to explore species that are most differentiated between reservations.

```{r, warning = FALSE, message = FALSE}

p_reservations<-rda(birdcomm_bin~reservatio,CMP_bbs_pcap_join_pcaponly_pcapsum,scale=T)

reservations_fitbirds<-envfit(p_reservations,birdcomm_bin)

reservations_fit<-envfit(p_reservations~reservatio,data=CMP_bbs_pcap_join_pcaponly_pcapsum,scale=T)


CMP_bbs_pcap_join_pcaponly_pcapsum$site<-rownames(CMP_bbs_pcap_join_pcaponly_pcapsum)

plot_df_reservations <- scores(p_reservations, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("site") %>% 
  full_join(CMP_bbs_pcap_join_pcaponly_pcapsum, by = "site")

plot_rda_reservations <- ggplot(plot_df_reservations, aes(x = RDA1, y = RDA2, color = reservatio)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "RDA")
plot_rda_reservations


fitreservations_pvals <- reservations_fitbirds$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".")

# extract coordinates for species, only keep species with p-val = 0.001
fit_reservations_spp <- reservations_fitbirds %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., fitreservations_pvals, by = "species") %>% 
  filter(pvals == 0.001)
fit_reservations_spp

fit_reservations <- reservations_fit %>% 
  scores(., display = "factors") %>% 
  as.data.frame() %>%
  rownames_to_column("reservations")

rda_reservation_plot_new <- ggplot(plot_df_reservations, aes(x = RDA1, y = RDA2)) +coord_fixed() +
  geom_point(aes(color = reservatio), size = 3, alpha = 0.8) +
  geom_segment(data = fit_reservations_spp, aes(x = 0, xend = RDA1, y = 0, yend = RDA2),col = "black") +
  geom_text(data = fit_reservations_spp, aes(label = species))+
  geom_text(data=as.data.frame(fit_reservations),aes(label=reservations))
rda_reservation_plot_new

```

Interesting! So when we consider reservation-of-origin, Hinckley seems to have a pretty unique bird community overall, and groups negatively along RDA1. In contrast, Brookside, Ohio and Erie Canal, and Washington all group positively along RDA1 - and are all quite heavily urbanized.

While I personally think the environmental gradient analyses are a bit more interesting, this does highlight reservations that are more or less distinct in bird community space. We can also plot just the reservations alone too:

```{r}
ggplot(plot_df_reservations, aes(x = RDA1, y = RDA2)) +
  coord_fixed() +
  geom_text(data=as.data.frame(fit_reservations),aes(label=reservations))+xlim(-2,4)+ylim(-4,2)
```

#### lda of reservations

```{r, warning = FALSE, message = FALSE,eval=FALSE}
reservation<-factor(CMP_bbs_pcap_join_pcaponly_pcapsum$reservatio)
reservation_min3<-reservation[!(reservation %in% c("BK","EC","GP","HU","WA"))]

birdcomm_bin_min3<-birdcomm_bin[!(CMP_bbs_pcap_join_pcaponly_pcapsum$reservatio %in% c("BK","EC","GP","HU","WA")),]

birdcomm_bin_min3_drop1<-birdcomm_bin_min3[colSums(birdcomm_bin_min3) > 1]



color_resid_dropconstant<-color_resid[(colnames(birdcomm_bin) %in% colnames(birdcomm_bin_min3_drop1))]


lda_birdreserv<-lda(birdcomm_bin_min3_drop1, grouping = reservation_min3)
ggord(lda_birdreserv, reservation_min3, xlim=c(-15,15),ylim = c(-20, 20),txt=NULL,arrow=NULL)
ggord(lda_birdreserv, reservation_min3, xlim=c(-25,25),ylim = c(-20, 20),txt=NULL,arrow=NULL,alpha=0,alpha_el=0.5)
ggord(lda_birdreserv, reservation_min3, xlim=c(-25,25),ylim = c(-20, 20),alpha=0,alpha_el=0.5,veccol=color_resid_dropconstant,labcol=color_resid_dropconstant)

ggord(lda_birdreserv, reservation_min3, xlim=c(-25,25),ylim = c(-20, 20),veccol=color_resid_dropconstant,labcol=color_resid_dropconstant)


ggord(lda_birdreserv, reservation_min3, xlim=c(-10,10),ylim = c(-10, 10),alpha=0,alpha_el=0.5,veccol=color_resid_dropconstant,labcol=color_resid_dropconstant)

ggord(lda_birdreserv, reservation_min3, xlim=c(-7.5,7.5),ylim = c(-5, 6),alpha=0,alpha_el=0.5,var_sub = c("ACFL","HOWA","PIWO","SOSP"))


spe.class <- predict(lda_birdreserv)$class

# Posterior probabilities that the objects belong to those
# groups
spe.post <- predict(lda_birdreserv)$posterior

# Table of prior vs. predicted classifications
(spe.table <- table(reservation_min3, spe.class))


# Proportion of corrected classification
diag(prop.table(spe.table, 1))

```

### Community associations

Now, we can also look at how bird communities are differentiated between community types.

```{r, warning = FALSE, message = FALSE }

community<-factor(CMP_bbs_pcap_join_pcaponly_pcapsum$community.x)

p_community<-rda(birdcomm_bin~community,CMP_bbs_pcap_join_pcaponly_pcapsum,scale=T)

community_fitbirds<-envfit(p_community,birdcomm_bin)

community_fit<-envfit(p_community~community,data=CMP_bbs_pcap_join_pcaponly_pcapsum,scale=T)


CMP_bbs_pcap_join_pcaponly_pcapsum$site<-rownames(CMP_bbs_pcap_join_pcaponly_pcapsum)

plot_df_community <- scores(p_community, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("site") %>% 
  full_join(CMP_bbs_pcap_join_pcaponly_pcapsum, by = "site")

plot_rda_community <- ggplot(plot_df_community, aes(x = RDA1, y = RDA2, color = community)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "RDA")
plot_rda_community


fitcommunity_pvals <- community_fitbirds$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".")

# extract coordinates for species, only keep species with p-val = 0.001
fit_community_spp <- community_fitbirds %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., fitcommunity_pvals, by = "species") %>% 
  filter(pvals == 0.001)
fit_community_spp

fit_community <- community_fit %>% 
  scores(., display = "factors") %>% 
  as.data.frame() %>%
  rownames_to_column("community")

rda_communityn_plot_new <- ggplot(plot_df_community, aes(x = RDA1, y = RDA2)) +
  coord_fixed() +
  geom_point(aes(color = community), size = 3, alpha = 0.8) +
  geom_segment(data = fit_community_spp, aes(x = 0, xend = RDA1, y = 0, yend = RDA2),
               col = "black") +
  geom_text(data = fit_community_spp, aes(label = species))+
  geom_text(data=as.data.frame(fit_community),aes(label=community))
rda_communityn_plot_new

ggplot(plot_df_community, aes(x = RDA1, y = RDA2)) +
  coord_fixed() +
  geom_text(data=as.data.frame(fit_community),aes(label=community))+xlim(-2,4)+ylim(-1,5)

ggplot(plot_df_community, aes(x = RDA1, y = RDA2)) +
  coord_fixed() +
  geom_text(data=as.data.frame(fit_community_spp),aes(label=species))+xlim(-1,1)+ylim(-1,1)

```

For these ordinations, RDA1 seems to differentiate birds along an approximate gradient of forest cover - with negative loadings indicating more hardwood-associated bird communities and more positive loadings indicating more mesic/meadow-associated areas. Intriguingly, RDA2 then groups Mesic Meadows out from all other community types - with more positive values indicating more Mesic Meadow-associated birds.

Neotropical migrants: Acadian Fly-Catcher, Baltimore Oriole, Barn Swallow, Common Yellowthroat, Eastern Kingbird, Eastern Wood-Pewee, Hooded Warbler, Indigo Bunting, Orchard Oriole, Rose-Breasted Grosbeak, Red-Eyed Vireo, Scarlet Tanager, Warbling Vireo, Willow Flycatcher, Wood Thrush, Yellow Warbler = **16 species**

Resident: Carolina Wren, European Starling, Hairy Woodpecker, House Sparrow, Pileated Woodpecker, Song Sparrow, White-Breasted Nuthatch = **7 species**

Short-distance migrant: Brown Thrasher, Cedar Waxwing, Common Grackle, Gray Catbird, House Wren, Killdeer, Mourning Dove, Northern Rough-winged Swallow, Purple Finch, Red-winged Blackbird, Tree Swallow = **11 species**

Resident or migratory: Dark-eyed Junco = **1 species**

We also can explore linear discriminant analysis:

```{r,eval=FALSE}
community<-factor(CMP_bbs_pcap_join_pcaponly_pcapsum$community.x)



birdcomm_bin_drop1<-birdcomm_bin[colSums(birdcomm_bin_min3) > 1]


color_resid_drop1<-color_resid[(colnames(birdcomm_bin) %in% colnames(birdcomm_bin_drop1))]


lda_birdcomm<-lda(birdcomm_bin_drop1, grouping = community)
lda_birdcomm_full<-lda(birdcomm_bin, grouping = community)

ggord(lda_birdcomm, community, xlim=c(-15,30),ylim = c(-15, 15),txt=NULL,arrow=NULL)
ggord(lda_birdcomm, community, xlim=c(-15,30),ylim = c(-15, 15),txt=NULL,arrow=NULL,alpha=0,alpha_el=0.5)
ggord(lda_birdcomm, community, xlim=c(-15,30),ylim = c(-15, 15),alpha=0,alpha_el=0.5,labcol=color_resid_drop1)

ggord(lda_birdcomm_full, community, xlim=c(-15,30),ylim = c(-15, 15),alpha=0,alpha_el=0.5,labcol=color_resid)

ggord(lda_birdcomm_full, community, xlim=c(-10,25),ylim = c(-7.5, 12.5),alpha=0,alpha_el=0.5,var_sub = c("ACFL","HOWA","PIWO","SOSP"))



```

![](/G:/NaturalResources/Byer/datasets/BBS/lda_birdcomm.png)


### indicator species analysis

```{r}
library(indicspecies)

commclass = multipatt(birdcomm_bin, community, 
                   control = how(nperm=999),) 

summary(commclass) 
summary(commclass, indvalcomp=TRUE)
summary(commclass, alpha=1)



res<-CMP_bbs_pcap_join_pcaponly_pcapsum$reservatio
resclass = multipatt(birdcomm_bin, res, 
                   control = how(nperm=999)) 

summary(resclass) 
summary(resclass, indvalcomp=TRUE)


```

### co-occurrence networks

We can also see which bird species co-occur together.

```{r,warning=FALSE,message=FALSE,results='hide'}
CMP_bbs_pcap_join_pcaponly_commsumm<-CMP_bbs_pcap_join_pcaponly %>% 
  group_by(community,species_4_) %>%
  summarise(n=n()) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0) 
CMP_bbs_pcap_join_pcaponly_commsumm<-column_to_rownames(CMP_bbs_pcap_join_pcaponly_commsumm,var = "community")

CMP_bbs_pcap_join_pcaponly_commsumm<-CMP_bbs_pcap_join_pcaponly_commsumm[,-1]

CMP_bbs_pcap_join_pcaponly_commsumm_presabs<-CMP_bbs_pcap_join_pcaponly_commsumm %>% mutate_if(is.numeric, ~1 * (. >= 1))

CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t<-t(CMP_bbs_pcap_join_pcaponly_commsumm_presabs)

CMP_bbs_pcap_join_pcaponly_reservsumm<-CMP_bbs_pcap_join_pcaponly %>% 
  group_by(reservatio,species_4_) %>%
  summarise(n=n()) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0) 
CMP_bbs_pcap_join_pcaponly_reservsumm<-column_to_rownames(CMP_bbs_pcap_join_pcaponly_reservsumm,var = "reservatio")

CMP_bbs_pcap_join_pcaponly_reservsumm<-CMP_bbs_pcap_join_pcaponly_reservsumm[,-1]

CMP_bbs_pcap_join_pcaponly_reservsumm_presabs<-CMP_bbs_pcap_join_pcaponly_reservsumm %>% mutate_if(is.numeric, ~1 * (. >= 1))

CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t<-t(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs)



birdcomm_bin_t<-t(birdcomm_bin)


BBSMigrants<-read.csv("G:/NaturalResources/Byer/datasets/BBS/BBS Migants.csv",header=T)

BBSMigrants_sub<-BBSMigrants[BBSMigrants$SpeciesCode %in% colnames(birdcomm_bin),]

BBSMigrants_sub_reorder<-BBSMigrants_sub[match(rownames(birdcomm_bin_t), BBSMigrants_sub$SpeciesCode),]

Residency<-BBSMigrants_sub_reorder$Residency

color_resid<-Residency

color_resid[color_resid %in% "NE"]<-"#56B4E9"

color_resid[color_resid %in% "M"]<-"#009E73"

color_resid[color_resid %in% "R"]<-"#E69F00" 


# presence/absence across plots
co <- print(cooccur(birdcomm_bin_t, spp_names = TRUE))

co[, "sp1_name"] == rownames(birdcomm_bin_t)[co$sp1]
co[, "sp2_name"] == rownames(birdcomm_bin_t)[co$sp2]



nodes <- data.frame(id = 1:nrow(birdcomm_bin_t),
                    label = rownames(birdcomm_bin_t),
                    color = color_resid,
                    shadow = TRUE) 
edges <- data.frame(from = co$sp1, to = co$sp2,
                    color = ifelse(co$p_lt <= 0.05, "#B0B2C1", "#3C3F51"),
                    dashes = ifelse(co$p_lt <= 0.05, TRUE, FALSE))

cooc<-cooccur(birdcomm_bin_t, spp_names = TRUE)

```

```{r, echo = FALSE }
visNetwork(nodes = nodes, edges = edges) %>%
    visIgraphLayout(layout = "layout_with_kk")

```

![coccur](G:/NaturalResources/Byer/datasets/BBS/coccurrence_birds_zoom.png)

```{r,warning=FALSE,message=FALSE,results='hide'}
# presence/absence across reservations


co_reserv <- print(cooccur(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t, spp_names = TRUE))

co_reserv[, "sp1_name"] == rownames(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t)[co_reserv$sp1]
co_reserv[, "sp2_name"] == rownames(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t)[co_reserv$sp2]


nodes_reserv <- data.frame(id = 1:nrow(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t),
                    label = rownames(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t),
                    color = color_resid,
                    shadow = TRUE) 
edges_reserv <- data.frame(from = co_reserv$sp1, to = co_reserv$sp2,
                    color = ifelse(co_reserv$p_lt <= 0.05, "#B0B2C1", "#3C3F51"),
                    dashes = ifelse(co_reserv$p_lt <= 0.05, TRUE, FALSE))

coocc_reserv<-cooccur(CMP_bbs_pcap_join_pcaponly_reservsumm_presabs_t, spp_names = TRUE)



# presence/absence across habitats

co_comm <- print(cooccur(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t, spp_names = TRUE))

co_comm[, "sp1_name"] == rownames(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t)[co_comm$sp1]
co_comm[, "sp2_name"] == rownames(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t)[co_comm$sp2]


nodes_comm <- data.frame(id = 1:nrow(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t),
                    label = rownames(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t),
                    color = color_resid,
                    shadow = TRUE) 
edges_comm <- data.frame(from = co_comm$sp1, to = co_comm$sp2,
                    color = ifelse(co_comm$p_lt <= 0.05, "#B0B2C1", "#3C3F51"),
                    dashes = ifelse(co_comm$p_lt <= 0.05, TRUE, FALSE))

coocc_comm<-cooccur(CMP_bbs_pcap_join_pcaponly_commsumm_presabs_t, spp_names = TRUE)

```

```{r}
visNetwork(nodes = nodes_comm, edges = edges_comm) %>%
    visIgraphLayout(layout = "layout_with_kk")
plot(coocc_comm)

plot(coocc_reserv)
```

### Now pRDA - with variance partitioning.

As a final sanity check, it can sometimes be difficult to disentangle geographic effects from environmental effects in these sorts of analyses. For example, what if (hypothetically) cover of seedless vascular plants is negatively associated with geographic coordinates? Thus, we might want to briefly check if the variance explained by our environmental axes is (or is not) confounded with geography. To do so, we will use the varpart() function, which partitions variance between model components:

```{r}

latlong<-CMP_bbs_pcap_join_pcaponly_pcapsum[,3:4]

vegecomm_latlong<-CMP_bbs_pcap_join_pcaponly_pcapsum[,3:26]

landvegcomm_latlong<-cbind(landcomm,vegecomm,latlong)

pcap_landveggeog<-varpart(birdcomm_bin,~ vibifq+vibifqnotrees+carex+cyper+dicot+
                     shade+shrub+hydro+svp+ap+fqi+bryo+hydro_rel+hydro_rel_notrees+sens_rel+
                     sens_rel_notree+tol_rel+tol_rel_notree+inv+small_tree+subcanopy,~developed+activity.area+
                     closest.developed+sanctioned.trail+bootleg.trail+closest.trail+developed.edge+stream.edge+
                     total.edges+fragment.area+fragment.perimeter+ldi_3k,~longitude+latitude,data=landvegcomm_latlong)
plot(pcap_landveggeog)
```

So - most of this variation is associated with these top covariates (X1), and NOT with latitude and longitude alone (X2). Good to see - this means we can be confident that these are actual environmental effects!

## community richness metrics

Next, we can explore the relationships between species richness and plot characteristics. We will start with plot-level explorations.

### plot-level analyses

#### plot-level richness and various indicators

Now, we will produce some exploratory models and plots of richness against basic indicators of vegetative quality, including the Floristic Quality Indicator (FQI) and the Vegetative Index of Biotic Integrity (VIBI).

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}
S <- specnumber(birdcomm_bin)

vegecomm_richness<-cbind(vegecomm,S)

S_vibi<-lm(S~vibifq,vegecomm_richness)

S_fqi<-lm(S~fqi,vegecomm_richness)

ggplot(aes(x=vibifq,y=S),data=vegecomm_richness)+geom_point()+geom_smooth()

ggplot(aes(x=fqi,y=S),data=vegecomm_richness)+geom_point()+geom_smooth()

```

Somewhat unexpectedly, this seems to suggest that higher VIBI scores actually produce slightly *less* species-rich communities. What could be causing this? Well, to start - perhaps the number of surveys for each plot may be influencing this.

We can generate a summary of the number of surveys for each plot.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}

pcap_surveynumber<-CMP_bbs_pcap_join_pcaponly %>% 
  group_by(simp_plot) %>%
  summarise(n=n_distinct(date)
            ) 
vegecomm_richness$surveycount<-pcap_surveynumber$n

CMP_bbs_pcap_join_pcaponly_pcapsum_date<-CMP_bbs_pcap_join_pcaponly %>% 
  group_by(simp_plot, reservatio,date,species_4_) %>%
  summarise(n=n(),longitude=mean(xcoord), latitude=mean(ycoord),vibifq=mean(vibi_fq),vibifqnotrees=mean(vibi_fq_no_trees),carex=mean(carex_metric_value),cyper=mean(cyperaceae_metric_value),
            dicot=mean(dicot_metric_value),shade=mean(shade_metric_value),shrub=mean(shrub_metric_value),
            hydro=mean(hydrophyte_metric_value),svp=mean(svp_metric_value),ap=mean(ap_ratio_metric_value),
            fqi=mean(fqai_score),bryo=mean(bryophyte_metric_value),hydro_rel=mean(hydrophyte_rel_cov_metric_value),
            hydro_rel_notrees=mean(hydrophyte_rel_cov_no_trees),
            sens_rel=mean(sensitive_rel_cov_metric_value),
            sens_rel_notree=mean(sensitive_rel_cov_no_trees),
            tol_rel=mean(tolerant_rel_cov_metric_value),
            tol_rel_notree=mean(tolerant_rel_cov_no_trees),
            inv=mean(invasive_graminoids_metric_value),
            small_tree=mean(small_tree_metric_value),
            subcanopy=mean(subcanopy_iv),
            canopy=mean(canopy_iv.1)
            ) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0)

birds_bycount<-CMP_bbs_pcap_join_pcaponly_pcapsum_date[,29:ncol(CMP_bbs_pcap_join_pcaponly_pcapsum_date)]

vegecomm_bycount<-CMP_bbs_pcap_join_pcaponly_pcapsum_date[,1:28]

landcomm$simp_plot<-rownames(landcomm)

simp_plot_bycount<-data.frame(vegecomm_bycount$simp_plot)

colnames(simp_plot_bycount)<-"simp_plot"

class(simp_plot_bycount$simp_plot)<-"character"

landcomm_bycount<-left_join(simp_plot_bycount,landcomm,by="simp_plot")

index<-as.numeric(factor(CMP_bbs_pcap_join_pcaponly_pcapsum_date$simp_plot))
index_unique<-unique(index)

rarefylist<-list()

for(i in index_unique){
  birds_temp<-birds_bycount[index %in% i,]
  rarefylist[[i]]<- specaccum(birds_temp)
}

totalspecaccum<-specaccum(birds_bycount)

plot(totalspecaccum,lwd=2,cex.axis=1.5,xlab="",ylab="")



Accum.plot <- accumcomp(birds_bycount, y=CMP_bbs_pcap_join_pcaponly_pcapsum_date, factor='simp_plot', 
    method='exact', conditioned=FALSE, plotit=FALSE)
Accum.plot

accum.plot.long1 <- accumcomp.long(Accum.plot, ci=NA, label.freq=1)
head(accum.plot.long1)

accum.plot.long1$reservatio<-rev(CMP_bbs_pcap_join_pcaponly_pcapsum_date$reservatio)


p.plot <- ggplot(data=accum.plot.long1, aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) + 
    geom_line(aes(colour=reservatio,group=Grouping), size=2) +
    geom_point(data=subset(accum.plot.long1, labelit==TRUE), 
               aes(colour=reservatio,group=Grouping), size=2) + scale_color_viridis_d(alpha = 0.7)+
    labs(x = "visits", y = "bird species", colour = "reservations", shape = "reservations") +theme_classic(base_size=16)#+theme(legend.position = "none")
p.plot


Accum.reserv <- accumcomp(birds_bycount, y=CMP_bbs_pcap_join_pcaponly_pcapsum_date, factor='reservatio', 
    method='exact', conditioned=FALSE, plotit=FALSE)
Accum.reserv

accum.res.long1 <- accumcomp.long(Accum.reserv, ci=NA, label.freq=5)
head(accum.res.long1)


p.res <- ggplot(data=accum.res.long1, aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) + 
    geom_line(aes(colour=Grouping), size=2) +
    geom_point(data=subset(accum.res.long1, labelit==TRUE), 
               aes(colour=Grouping), size=2) + scale_color_viridis_d(alpha = 0.7)+
    labs(x = "visits", y = "bird species", colour = "reservations", shape = "reservations") + theme_classic(base_size=16)
p.res


```

So the number of surveys clearly has an effect on the species richness of the site. This is somewhat difficult to account for, but we will attempt to do so using mixed effects models. I then use Akaike's Information Criterion (AIC for short) to rank these models. The lowest number is the best, and any model within 2 AIC of the top model is potentially worth interpreting.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}
simp_plot<-factor(CMP_bbs_pcap_join_pcaponly_pcapsum_date$simp_plot)

date<-strptime(CMP_bbs_pcap_join_pcaponly_pcapsum_date$date,format="%m/%d/%Y")

month<-month(date)

S_plotdate<-specnumber(birds_bycount)

Rich_vibifq<-lmer(S_plotdate~vibifq+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_vibifqnotrees<-lmer(S_plotdate~vibifqnotrees+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_carex<-lmer(S_plotdate~carex+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_cyper<-lmer(S_plotdate~cyper+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_dicot<-lmer(S_plotdate~dicot+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_shade<-lmer(S_plotdate~shade+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_hydro<-lmer(S_plotdate~hydro+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_shrub<-lmer(S_plotdate~shrub+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_svp<-lmer(S_plotdate~svp+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_ap<-lmer(S_plotdate~ap+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_bryo<-lmer(S_plotdate~bryo+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_sens_rel<-lmer(S_plotdate~sens_rel+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_tol_rel<-lmer(S_plotdate~tol_rel+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_fqi<-lmer(S_plotdate~fqi+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_inv<-lmer(S_plotdate~inv+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_small_tree<-lmer(S_plotdate~small_tree+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_subcanopy<-lmer(S_plotdate~subcanopy+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_canopy<-lmer(S_plotdate~canopy+(1|simp_plot),vegecomm_bycount,REML=FALSE)

Rich_developed<-lmer(S_plotdate~developed+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_activity.area<-lmer(S_plotdate~activity.area+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_closest.developed<-lmer(S_plotdate~closest.developed+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_sanctioned.trail<-lmer(S_plotdate~sanctioned.trail+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_bootleg.trail<-lmer(S_plotdate~bootleg.trail+(1|simp_plot),landcomm_bycount,REML=FALSE)
summary(Rich_bootleg.trail)

Rich_developed.edge<-lmer(S_plotdate~developed.edge+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_stream.edge<-lmer(S_plotdate~stream.edge+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_total.edge<-lmer(S_plotdate~total.edges+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_fragment.area<-lmer(S_plotdate~fragment.area+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_fragment.perimeter<-lmer(S_plotdate~fragment.perimeter+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_ldi.index.score<-lmer(S_plotdate~ldi_3k+(1|simp_plot),landcomm_bycount,REML=FALSE)

Rich_null<-lmer(S_plotdate~1+(1|simp_plot),vegecomm_bycount,REML=FALSE)

richmods<-list(Rich_ap,Rich_bryo,Rich_canopy,Rich_carex,Rich_cyper,Rich_dicot,Rich_fqi,Rich_hydro,Rich_inv,Rich_sens_rel,Rich_shade,Rich_shrub,Rich_small_tree,Rich_subcanopy,Rich_svp,Rich_tol_rel,Rich_vibifq,Rich_vibifqnotrees,Rich_activity.area,Rich_bootleg.trail,Rich_closest.developed,Rich_developed,Rich_developed.edge,Rich_fragment.area,Rich_fragment.perimeter,Rich_ldi.index.score,Rich_stream.edge,Rich_total.edge,Rich_null)

aictab(richmods)


```

So richness - at a plot level, and after accounting for plot identity - is determined by how many tolerant species are in the associated plot. And this is much more predictive than any other model.

Here is the plot for this top model:

```{r, echo = FALSE}

vegecomm_bycount$simp_plot<-factor(vegecomm_bycount$simp_plot)


effects_tolrel <- effects::effect(term= "tol_rel", mod= Rich_tol_rel)
summary(effects_tolrel) #output of what the values are
x_tolrel <- as.data.frame(effects_tolrel)


p<-ggplot(aes(x=tol_rel,y=S_plotdate),data=vegecomm_bycount)+geom_point(alpha=0.5)+
  geom_point(data=x_tolrel, aes(x=tol_rel, y=fit), color="#56B4E9") +
  geom_line(data=x_tolrel, aes(x=tol_rel, y=fit), color="#56B4E9",size=2) +
  geom_ribbon(data=x_tolrel, aes(x=tol_rel, y= fit,ymin=lower, ymax=upper), alpha= 0.3, fill="#56B4E9") +
  labs(x="Relative cover of tolerant plants", y="Number of species")+theme_classic(base_size=16)


p
```

We can also verify that our mixed effects model fits better compared to the fixed effects model.

```{r}
Rich_tol_rel_fixed<-lm(S_plotdate~tol_rel,vegecomm_bycount)
anova(Rich_tol_rel, Rich_tol_rel_fixed) 
```

This confirms that we chose correctly - the mixed effects model fits better than the fixed effects-only model.

We can also inspect how this observation-level mixed effect model compares to a plot-level, fixed effect model (in other words - a view that just looks at richness at a plot level - aggregating over observations).

```{r}
S_tol_rel<-lm(S~tol_rel,vegecomm_richness)
confint(S_tol_rel)

confint(Rich_tol_rel)

```

We can see that, while the covariate estimate for the plot-level model is higher, it is also estimated with much more variance (its confidence intervals are wider). This is not surprising - our functional sample size for this dataset is 164 plots. In contrast, while the observation-level mixed-effects model has a lower covariate estimate, we have tighter confidence intervals around this estimate - likely by virtue of a larger number of samples and a more effectively parameterized model.

### reservation-level analyses

Now we are going to re-summarize this dataset at a reservation-level. While we will have limited power for many comparisons of interest, this could provide some indication of whether covariate relationships vary across scales.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}

birdcomm_reserv<-CMP_bbs_pcap_join_pcaponly %>%
  group_by(reservatio,species_4_) %>%
  summarise(n=n()) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0) 

birdcomm_reserv<-column_to_rownames(birdcomm_reserv,var="reservatio")
birdcomm_reserv<-birdcomm_reserv[,-1]
birdcomm_reserv_bin<-birdcomm_reserv %>% mutate_if(is.numeric, ~1 * (. >= 1))

reservspcount<-specnumber(birdcomm_reserv_bin)

CMP_bbs_pcap_join_pcaponly_landscape<-left_join(x = CMP_bbs_pcap_join_pcaponly,y = pcap_1styear_landscape,by="simp_plot")

vegelandcomm_reserv<-CMP_bbs_pcap_join_pcaponly_landscape %>%
  group_by(reservatio) %>%
  summarise(vibifq=mean(vibi_fq,na.rm=T),vibifqnotrees=mean(vibi_fq_no_trees,na.rm=T),carex=mean(carex_metric_value,na.rm=T),
            cyper=mean(cyperaceae_metric_value,na.rm=T),
            dicot=mean(dicot_metric_value,na.rm=T),shade=mean(shade_metric_value,na.rm=T),shrub=mean(shrub_metric_value,na.rm=T),
            hydro=mean(hydrophyte_metric_value,na.rm=T),svp=mean(svp_metric_value,na.rm=T),ap=mean(ap_ratio_metric_value,na.rm=T),
            fqi=mean(fqai_score,na.rm=T),bryo=mean(bryophyte_metric_value,na.rm=T),hydro_rel=mean(hydrophyte_rel_cov_metric_value,na.rm=T),
            hydro_rel_notrees=mean(hydrophyte_rel_cov_no_trees,na.rm=T),
            sens_rel=mean(sensitive_rel_cov_metric_value,na.rm=T),
            sens_rel_notree=mean(sensitive_rel_cov_no_trees,na.rm=T),
            tol_rel=mean(tolerant_rel_cov_metric_value,na.rm=T),
            tol_rel_notree=mean(tolerant_rel_cov_no_trees,na.rm=T),
            inv=mean(invasive_graminoids_metric_value,na.rm=T),
            small_tree=mean(small_tree_metric_value,na.rm=T),
            subcanopy=mean(subcanopy_iv,na.rm=T),
            canopy=mean(canopy_iv.1,na.rm=T),
            developed=mean(as.numeric(developed),na.rm=T),
            activity.area=mean(as.numeric(activity.area),na.rm=T),
            closest.developed=mean(as.numeric(closest.developed),na.rm=T),
            sanctioned.trail=mean(as.numeric(sanctioned.trail),na.rm=T),
            bootleg.trail=mean(as.numeric(bootleg.trail),na.rm=T),
            closest.trail=mean(as.numeric(closest.trail),na.rm=T),
            developed.edge=mean(as.numeric(developed.edge),na.rm=T),
            stream.edge=mean(as.numeric(stream.edge),na.rm=T),
            total.edges=mean(as.numeric(total.edges),na.rm=T),
            fragment.area=mean(as.numeric(fragment.area),na.rm=T),
            fragment.perimeter=mean(as.numeric(fragment.perimeter),na.rm=T),
            ldi_3k=mean(as.numeric(ldi_3k),na.rm=T),
            numsurveys=n_distinct(paste0(simp_plot,date)))
vegelandcomm_reserv_richness<-cbind(vegelandcomm_reserv,reservspcount)




ggplot(aes(x=vibifq,y=reservspcount),data=vegelandcomm_reserv_richness)+geom_point()+geom_smooth(method="lm")

```

This doesn't quite get at what we want - this displays species accumulation across reservations after accounting for survey effort per reservation. Let's try exploring reservation-by-reservation rarefaction with the previous observation-level dataset.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}

index<-as.numeric(factor(CMP_bbs_pcap_join_pcaponly_pcapsum_date$reservatio))
index_unique<-unique(index)

rarefylist_reservation<-list()

for(i in index_unique){
  birds_temp<-birds_bycount[index %in% i,]
  rarefylist_reservation[[i]]<- specaccum(birds_temp)
}

plot(totalspecaccum)

plot(rarefylist_reservation[[4]])

interpolatedrichness_n3<-data.frame(levels(factor(CMP_bbs_pcap_join_pcaponly_pcapsum_date$reservatio)),rep(1,16))

colnames(interpolatedrichness_n3)<-c("reservation","richness")

for(i in index_unique){
  birds_temp<-birds_bycount[index %in% i,]
  interpolatedrichness_n3$richness[i]<- predict(specaccum(birds_temp),newdata=3)
}
```

With the plot-level data, we could easily account for variation in survey effort across plots with a mixed model design, but this case is a bit more complicated. We are interested in reservation-level species richness, but know that reservations were visited different numbers of times - based on the number of plots and the number of surveys/plot. Thus, the easiest thing to start with is simply using species richness estimates interpolated to the least number of surveys per reservation (3, in our case).

Now we can proceed with exploring richness patterns across reservations.

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}

vegelandcomm_reserv_richness$interrich_n3<-interpolatedrichness_n3$richness

Rich_reserv_vibifq<-lm(interrich_n3~vibifq,vegelandcomm_reserv_richness)

Rich_reserv_vibifqnotrees<-lm(interrich_n3~vibifqnotrees,vegelandcomm_reserv_richness)

Rich_reserv_carex<-lm(interrich_n3~carex,vegelandcomm_reserv_richness)

Rich_reserv_cyper<-lm(interrich_n3~cyper,vegelandcomm_reserv_richness)

Rich_reserv_dicot<-lm(interrich_n3~dicot,vegelandcomm_reserv_richness)

Rich_reserv_shade<-lm(interrich_n3~shade,vegelandcomm_reserv_richness)

Rich_reserv_hydro<-lm(interrich_n3~hydro,vegelandcomm_reserv_richness)

Rich_reserv_shrub<-lm(interrich_n3~shrub,vegelandcomm_reserv_richness)

Rich_reserv_svp<-lm(interrich_n3~svp,vegelandcomm_reserv_richness)

Rich_reserv_ap<-lm(interrich_n3~ap,vegelandcomm_reserv_richness)

Rich_reserv_bryo<-lm(interrich_n3~bryo,vegelandcomm_reserv_richness)

Rich_reserv_sens_rel<-lm(interrich_n3~sens_rel,vegelandcomm_reserv_richness)

Rich_reserv_tol_rel<-lm(interrich_n3~tol_rel,vegelandcomm_reserv_richness)

Rich_reserv_fqi<-lm(interrich_n3~fqi,vegelandcomm_reserv_richness)

Rich_reserv_inv<-lm(interrich_n3~inv,vegelandcomm_reserv_richness)

Rich_reserv_small_tree<-lm(interrich_n3~small_tree,vegelandcomm_reserv_richness)

Rich_reserv_subcanopy<-lm(interrich_n3~subcanopy,vegelandcomm_reserv_richness)

Rich_reserv_canopy<-lm(interrich_n3~canopy,vegelandcomm_reserv_richness)

Rich_reserv_developed<-lm(interrich_n3~developed,vegelandcomm_reserv_richness)

Rich_reserv_ldi3k<-lm(interrich_n3~ldi_3k,vegelandcomm_reserv_richness)

Rich_reserv_null<-lm(interrich_n3~1,vegelandcomm_reserv_richness)

richmods_reserv<-list(Rich_reserv_ap,Rich_reserv_bryo,Rich_reserv_canopy,Rich_reserv_carex,Rich_reserv_cyper,Rich_reserv_dicot,Rich_reserv_fqi,Rich_reserv_hydro,Rich_reserv_inv,Rich_reserv_sens_rel,Rich_reserv_shade,Rich_reserv_shrub,Rich_reserv_small_tree,Rich_reserv_subcanopy,Rich_reserv_svp,Rich_reserv_tol_rel,Rich_reserv_vibifq,Rich_reserv_vibifqnotrees,Rich_reserv_developed,Rich_reserv_ldi3k,Rich_reserv_null)

aictab(richmods_reserv)

ggplot(aes(x=vibifqnotrees,y=interrich_n3,label=reservatio),data=vegelandcomm_reserv_richness)+geom_point()+geom_smooth(method="lm")+theme_classic(base_size=24)+xlab("VIBI-FQ (excluding trees)")+ylab("Reservation-level species richness")+
geom_text(hjust=1, vjust=-0.5,size=8)

```

although our power is a bit limited above, it does appear that the Vegetative Index of Biotic Integrity - at a reservation-level - does appear to predict bird species richness (as long as we do not include woody plants in that list!)

we can also plot out richness for each site:

```{r,warning=FALSE,error=FALSE,message=FALSE,echo=FALSE}
ggplot(aes(x=reservatio,y=reservspcount),data=vegecomm_reserv_richness)+geom_col()+theme_classic(base_size=24)+xlab("Reservation")+ylab("Species richness")

ggplot(aes(x=reservatio,y=interrich_n3),data=vegecomm_reserv_richness)+geom_col()+theme_classic(base_size=24)+xlab("Reservation")+ylab("Rarefied species richness")
```

In confirmation of our prior ordination plots, it now appears that Rocky River is one of the most species rich areas - followed by Hinckley, South Chagrin, Bedford, and Brecksville.

>>>>>>>> 428d11ca61457c1db8950a8dfc5b38d9906569b4:bbs_cmp_bin.Rmd
# multi-species occupancy modelling

```{r,echo = FALSE, warning = FALSE, message = FALSE}
vegecomm<-CMP_bbs_pcap_join_pcaponly_pcapsum[,3:28]


class(CMP_bbs_pcap_join_pcaponly$simp_plot)<-"character"

landcomm$simp_plot<-rownames(landcomm)

landvegcomm<-cbind(vegecomm,landcomm)

CMP_bbs_pcap_join_pcaponly_landcomm<-left_join(CMP_bbs_pcap_join_pcaponly,landcomm,by="simp_plot")

CMP_bbs_pcap_join_pcaponly_landcomm$simp_plot<-as.factor(CMP_bbs_pcap_join_pcaponly_landcomm$simp_plot)

times<-hm(CMP_bbs_pcap_join_pcaponly_landcomm$time_start)
time_minutes<-hour(times)*60 + minute(times)
CMP_bbs_pcap_join_pcaponly_landcomm$time_minutes<-time_minutes
CMP_bbs_pcap_join_pcaponly_detecthistory_species<-CMP_bbs_pcap_join_pcaponly_landcomm %>% 
  group_by(simp_plot, date, species_4_) %>%
  summarise(n=n(),time_minutes=mean(time_minutes)) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0) 

CMP_bbs_pcap_join_pcaponly_detecthistory_species_bin<-CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% 
  ungroup() %>%
  dplyr::select(ACFL:YTWA) 

CMP_bbs_pcap_join_pcaponly_detecthistory_species_bin[CMP_bbs_pcap_join_pcaponly_detecthistory_species_bin > 0] <- 1   

CMP_bbs_pcap_join_pcaponly_detecthistory_species[,5:107]<-CMP_bbs_pcap_join_pcaponly_detecthistory_species_bin[,1:103]

sitechecks<-CMP_bbs_pcap_join_pcaponly_detecthistory_species[,1:2]

sitechecks$date<- as.Date(sitechecks$date , format = "%m/%d/%Y")

sitechecks$datecount<-as.numeric(sitechecks$date-min(sitechecks$date)+1)




sitechecks_surveyhistory<-sitechecks %>%
  group_by(simp_plot) %>% 
  mutate(check=as.character(dense_rank(date))) %>%
  arrange(simp_plot) %>%
  spread(check,datecount) %>%
  summarise(`1` = mean(`1`,na.rm=T),
            `2`=mean(`2`,na.rm=T),
            `3`=mean(`3`,na.rm=T),
            `4`=mean(`4`,na.rm=T),
            `5`=mean(`5`,na.rm=T),
            `6`=mean(`6`,na.rm=T),
            `7`=mean(`7`,na.rm=T),
            `8`=mean(`8`,na.rm=T))

sitetimes<-CMP_bbs_pcap_join_pcaponly_detecthistory_species[,c(1:3)]

sitetimes_surveyhistory<-sitetimes %>%
  group_by(simp_plot) %>% 
  mutate(check=as.character(dense_rank(date))) %>%
  arrange(simp_plot) %>%
  spread(check,time_minutes) %>%
  summarise(`1` = mean(`1`,na.rm=T),
            `2`=mean(`2`,na.rm=T),
            `3`=mean(`3`,na.rm=T),
            `4`=mean(`4`,na.rm=T),
            `5`=mean(`5`,na.rm=T),
            `6`=mean(`6`,na.rm=T),
            `7`=mean(`7`,na.rm=T),
            `8`=mean(`8`,na.rm=T))

CMP_bbs_pcap_join_pcaponly_detecthistory_species$datecount<-sitechecks$datecount


sitetimes_surveyhistory_forindexing<-sitetimes %>%
  group_by(simp_plot) %>% 
  mutate(check=as.character(dense_rank(date))) %>%
  arrange(simp_plot) %>%
  spread(check,time_minutes)


CMP_bbs_pcap_join_pcaponly_detecthistory_firstcheck<-CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[1])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount)) 
  

firstcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_firstcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name")

CMP_bbs_pcap_join_pcaponly_detecthistory_secondcheck<-CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[2])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

secondcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_secondcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 


CMP_bbs_pcap_join_pcaponly_detecthistory_thirdcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[3])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

thirdcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_thirdcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 

CMP_bbs_pcap_join_pcaponly_detecthistory_fourthcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[4])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

fourthcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_fourthcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name")

CMP_bbs_pcap_join_pcaponly_detecthistory_fifthcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[5])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

fifthcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_fifthcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 

CMP_bbs_pcap_join_pcaponly_detecthistory_sixthcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[6])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

sixthcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_sixthcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 


CMP_bbs_pcap_join_pcaponly_detecthistory_seventhcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[7])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

seventhcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_seventhcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 


CMP_bbs_pcap_join_pcaponly_detecthistory_eighthcheck<- CMP_bbs_pcap_join_pcaponly_detecthistory_species %>% group_by(simp_plot) %>% 
  arrange(datecount) %>% 
  summarise_all(~list(.[8])) %>% 
  unnest(cols = c(date, time_minutes, V1, ACFL, ALFL, AMCR, AMGO, 
                  AMKE, AMRE, AMRO, AMWO, BADO, BAEA, BANS, BAOR, BARS, BCCH, 
                  BEKI, BGGN, BHCO, BHVI, BLJA, BOBO, BRCR, BRTH, BTNW, BWHA, 
                  BWWA, CANG, CARW, CEDW, CERW, CHSP, CHSW, CLSW, COGR, COHA, 
                  COYE, DEJU, DOWO, EABL, EAKI, EAME, EAPH, EATO, EAWP, EUST, 
                  FISP, GBHE, GCFL, GHOW, GRCA, GRHE, HAWO, HERG, HETH, HOFI, 
                  HOSP, HOWA, HOWR, INBU, KILL, LOWA, MALL, MODO, NOCA, NOFL, 
                  NOPA, NRWS, OROR, OVEN, PIWO, PUFI, PUMA, RBGR, RBGU, RBNU, 
                  RBWO, REVI, RHWO, ROPI, RSHA, RTHA, RTHU, RWBL, SAVS, SCTA, 
                  SOSP, SWSP, TRES, TUTI, TUVU, VEER, VIRA, WAVI, WBNU, 
                  WEVI, WIFL, WITU, WIWR, WODU, WOTH, YBCU, YEWA, YTVI, YTWA, 
                  datecount))

eighthcheck_birds<-CMP_bbs_pcap_join_pcaponly_detecthistory_eighthcheck %>%
  dplyr::select(ACFL:YTWA) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  pivot_wider(names_from=rowname) %>%
  column_to_rownames(var = "name") 

bbs_occobject<-list()

bbs_occobject$y<-array(dim=c(103,164,8))

bbs_occobject$y <- array(c(as.matrix(firstcheck_birds),as.matrix(secondcheck_birds),
                           as.matrix(thirdcheck_birds),as.matrix(fourthcheck_birds),
                           as.matrix(fifthcheck_birds),as.matrix(sixthcheck_birds),
                           as.matrix(seventhcheck_birds),as.matrix(eighthcheck_birds)), dim=c(103,164,8))

roaddist<-data.frame(CMP_bbs_pcap_join_pcaponly_landcomm$dist_road)

roaddist$simp_plot<-factor(CMP_bbs_pcap_join_pcaponly_landcomm$simp_plot)

sitechecks_road<-data.frame(sitechecks_surveyhistory$simp_plot,1)

colnames(sitechecks_road)<-c("simp_plot","dummy")

sitechecks_road_2<-merge(sitechecks_road,roaddist,by="simp_plot")

colnames(sitechecks_road_2)<-c("simp_plot","dummy","dist_road")

sitechecks_road_2<-sitechecks_road_2[!duplicated(sitechecks_road_2), ]


sitechecks_road_detcov<-as.matrix(cbind(sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road,sitechecks_road_2$dist_road))

bbs_occobject$det.covs$day<-as.matrix(sitechecks_surveyhistory[,2:9])

seasons<-round(sitechecks_surveyhistory[,2:9]/365)+1

dayyear<-bbs_occobject$det.covs$day-((seasons-1)*365)

bbs_occobject$det.covs$tod<-as.matrix(sitetimes_surveyhistory[,2:9])

bbs_occobject$det.covs$seasons<-as.matrix(seasons)

bbs_occobject$det.covs$dayyear<-as.matrix(dayyear)

bbs_occobject$det.covs$dist_road<-as.matrix(sitechecks_road_detcov)


observer<-CMP_bbs_pcap_join_pcaponly[,c(5,6,7)]


observers<-observer %>%                             
  mutate(observer = replace(observer, observer == "Tim krynak", "Tim Krynak")) %>%  
  mutate(observer = replace(observer, observer == "krynak", "Tim Krynak")) %>%
  mutate(observer = replace(observer, observer == "Krynak", "Tim Krynak")) %>%
  mutate(observer = replace(observer, observer == "Rem", "Rem Moll")) %>%
  mutate(observer = replace(observer, observer == "Matt and Erik", "Matt Kneitel")) %>%
  mutate(observer = replace(observer, observer == "Jen Brunfield", "Jen Brumfield")) %>%
  mutate(observer = replace(observer, observer == "JB", "Jen Brumfield")) %>%
  mutate(observer = replace(observer, observer == "Jb", "Jen Brumfield")) %>%
  mutate(observer = replace(observer, observer == "Brumfield", "Jen Brumfield")) %>%
  mutate(observer = replace(observer, observer == "Erik Shaffer,", "Erik Shaffer")) %>%
  mutate(observer = replace(observer, observer == "Chasar", "Dwight Chasar")) %>%
  mutate(observer = replace(observer, observer == "Slaby", "Brian Slaby")) %>%
  mutate(observer = replace(observer, observer == "Kneitel", "Matt Kneitel")) %>%
  mutate(observer = replace(observer, observer == "Patti", "Patti Donnellan")) %>%
  mutate(observer = replace(observer, observer == "Howell", "Nancy Howell")) %>%
  mutate(observer = replace(observer, observer == "Erik Shaffer Matt K", "Erik Shaffer")) 

observers$simp_plot<-as.factor(observers$simp_plot)

CMP_bbs_pcap_join_pcaponly_landcomm_observers<-data.frame(left_join(CMP_bbs_pcap_join_pcaponly_landcomm,observers,by="simp_plot"))

CMP_bbs_pcap_join_pcaponly_detecthistory_observer<-CMP_bbs_pcap_join_pcaponly_landcomm_observers %>%
  group_by(simp_plot, date.x, species_4_,observer.y) %>%
  summarise(n=n()) %>%
  spread(species_4_,n) %>%
  replace(is.na(.),0)




sitechecks_observed<-CMP_bbs_pcap_join_pcaponly_detecthistory_observer[,c(1:3)]

sitechecks_observed$date.x<- as.Date(sitechecks_observed$date.x , format = "%m/%d/%Y")

sitechecks_observed$datecount<-as.numeric(sitechecks_observed$date.x-min(sitechecks$date)+1)

sitechecks_observed$observercat<-as.numeric(factor(sitechecks_observed$observer.y))

observerkey<-data.frame(sitechecks_observed$observer.y,as.numeric(factor(sitechecks_observed$observer.y)))


sitechecks_observed_surveyhistory<-sitechecks_observed %>%
  group_by(simp_plot) %>% 
  mutate(check=as.character(dense_rank(date.x))) %>%
  arrange(simp_plot) %>%
  spread(check,observer.y) %>%
  summarise(`1`=paste(unique(unlist(strsplit(paste(na.omit(`1`), collapse="; "),";"))),collapse="; "),
            `2`=paste(unique(unlist(strsplit(paste(na.omit(`2`), collapse="; "),";"))),collapse="; "),
            `3`=paste(unique(unlist(strsplit(paste(na.omit(`3`), collapse="; "),";"))),collapse="; "),
            `4`=paste(unique(unlist(strsplit(paste(na.omit(`4`), collapse="; "),";"))),collapse="; "),
            `5`=paste(unique(unlist(strsplit(paste(na.omit(`5`), collapse="; "),";"))),collapse="; "),
            `6`=paste(unique(unlist(strsplit(paste(na.omit(`6`), collapse="; "),";"))),collapse="; "),
            `7`=paste(unique(unlist(strsplit(paste(na.omit(`7`), collapse="; "),";"))),collapse="; "),
            `8`=paste(unique(unlist(strsplit(paste(na.omit(`8`), collapse="; "),";"))),collapse="; ")) %>% replace(.=="",NA)


observer<-sitechecks_observed_surveyhistory[,2:9]

observer$`1`<-as.numeric(factor(observer$`1`))

observer$`2`<-as.numeric(factor(observer$`2`))

observer$`3`<-as.numeric(factor(observer$`3`))

observer$`4`<-as.numeric(factor(observer$`4`))

observer$`5`<-as.numeric(factor(observer$`5`))

observer$`6`<-as.numeric(factor(observer$`6`))

observer$`7`<-as.numeric(factor(observer$`7`))

observer$`8`<-as.numeric(factor(observer$`8`))


bbs_occobject$det.covs$observer<-as.matrix(observer)

occcov<-landvegcomm[,-(1:2)]

cols<-seq(1,32,1)

occcov[,cols] = apply(occcov[,cols], 2, function(x) as.numeric(as.character(x)))

bbs_occobject$occ.covs<-as.matrix(occcov[,-33])


sppnames<-c("ACFL","ALFL","AMCR","AMGO","AMKE","AMRE","AMRO","AMWO","BADO","BAEA",
"BANS","BAOR","BARS","BCCH","BEKI","BGGN","BHCO","BHVI","BLJA","BOBO","BRCR","BRTH","BTNW","BWHA",
"BWWA","CANG","CARW","CEDW","CERW","CHSP","CHSW","CLSW","COGR","COHA","COYE","DEJU","DOWO","EABL","EAKI","EAME",
"EAPH","EATO","EAWP","EUST","FISP","GBHE","GCFL","GHOW","GRCA","GRHE","HAWO","HERG","HETH","HOFI",
"HOSP","HOWA","HOWR","INBU","KILL","LOWA","MALL","MODO","NOCA","NOFL","NOPA",
"NRWS","OROR","OVEN","PIWO","PUFI","PUMA","RBGR","RBGU","RBNU","RBWO","REVI",
"RHWO","ROPI","RSHA","RTHA","RTHU","RWBL","SAVS","SCTA","SOSP","SWSP",
"TRES","TUTI","TUVU","VEER","VIRA","WAVI","WBNU",
"WEVI","WIFL","WITU","WIWR","WODU","WOTH","YBCU","YEWA","YTVI","YTWA")


rownames(bbs_occobject$y)<-sppnames

bbs_occobject$coords<-as.matrix(landvegcomm[,1:2])

sppobserved_perplot<-apply(bbs_occobject$y,c(1,2),sum,na.rm=TRUE)

sppobserved_perplot <- sppobserved_perplot/sppobserved_perplot

sppobserved_perplot[is.na(sppobserved_perplot)]<-0


observed_spprichness<-apply(sppobserved_perplot,2,sum,na.rm=TRUE)

spprichness_byplot<-cbind(rownames(landvegcomm),landvegcomm[,1:2],observed_spprichness)
write.csv(spprichness_byplot,"spprichness_byplot.csv")
```




```{r, echo = FALSE, eval = FALSE}


## making simpler datasets

bbs_occobject_three<-list()

bbs_occobject_three$y<-array(dim=c(103,164,3))

bbs_occobject_three$y <- array(c(as.matrix(firstcheck_birds),as.matrix(secondcheck_birds),
                           as.matrix(thirdcheck_birds)), dim=c(103,164,3))

bbs_occobject_three$det.covs$day<-as.matrix(sitechecks_surveyhistory[,2:4])

seasons<-round(sitechecks_surveyhistory[,2:4]/365)+1

dayyear<-bbs_occobject_three$det.covs$day-((seasons-1)*365)

bbs_occobject_three$det.covs$tod<-as.matrix(sitetimes_surveyhistory[,2:4])

bbs_occobject_three$det.covs$seasons<-as.matrix(seasons)

bbs_occobject_three$det.covs$dayyear<-as.matrix(dayyear)

bbs_occobject_three$det.covs$dist_road<-as.matrix(sitechecks_road_detcov[,1:3])


#occcov<-landvegcomm[,-(1:3)]

#cols<-seq(1,34,1)

#occcov[,cols] = apply(occcov[,cols], 2, function(x) as.numeric(as.character(x)))

bbs_occobject_three$occ.covs<-as.matrix(occcov[,-33])



bbs_occobject_three$coords<-as.matrix(landvegcomm[,1:2])

rownames(bbs_occobject_three$y)<-sppnames

bbs_occobject_three$det.covs$observer<-as.matrix(observer[,1:3])



bbs_occobject_six<-list()

bbs_occobject_six$y<-array(dim=c(103,164,6))

bbs_occobject_six$y <- array(c(as.matrix(firstcheck_birds),as.matrix(secondcheck_birds),
                           as.matrix(thirdcheck_birds),as.matrix(fourthcheck_birds),
                           as.matrix(fifthcheck_birds),as.matrix(sixthcheck_birds)), dim=c(103,164,6))

bbs_occobject_six$det.covs$day<-as.matrix(sitechecks_surveyhistory[,2:7])

seasons<-round(sitechecks_surveyhistory[,2:7]/365)+1

dayyear<-bbs_occobject_six$det.covs$day-((seasons-1)*365)

bbs_occobject_six$det.covs$tod<-as.matrix(sitetimes_surveyhistory[,2:7])

bbs_occobject_six$det.covs$seasons<-as.matrix(seasons)

bbs_occobject_six$det.covs$dayyear<-as.matrix(dayyear)

bbs_occobject_six$det.covs$dist_road<-as.matrix(sitechecks_road_detcov[,1:6])



#occcov<-landvegcomm[,-(1:3)]

#cols<-seq(1,34,1)

#occcov[,cols] = apply(occcov[,cols], 2, function(x) as.numeric(as.character(x)))

bbs_occobject_six$occ.covs<-as.matrix(occcov[,-33])



bbs_occobject_six$coords<-as.matrix(landvegcomm[,1:2])

rownames(bbs_occobject_six$y)<-sppnames

bbs_occobject_six$det.covs$observer<-as.matrix(observer[,1:6])


```


After looking at the three, six, and eight sample surveys - virtually *no* sites are surveyed in the seventh and eighth surveys. Thus, using either the three or six sample versions will be best.And the three sample surveys almost always fit better than the six or eight; thus, I will proceed with those. 

## MSOM - running different models

### setting some basic parameters for the runs

```{r, eval = FALSE}
N <- dim(bbs_occobject$y)[1]
ms.inits <- list(alpha.comm = 0, 
                 beta.comm = 0, 
                 beta = 0, 
                 alpha = 0,
                 tau.sq.beta = 1, 
                 tau.sq.alpha = 1, 
                 z = apply(bbs_occobject$y, c(1, 2), max, na.rm = TRUE))
ms.priors <- list(beta.comm.normal = list(mean = 0, var = 2.72),
                  alpha.comm.normal = list(mean = 0, var = 2.72), 
                  tau.sq.beta.ig = list(a = 0.1, b = 0.1), 
                  tau.sq.alpha.ig = list(a = 0.1, b = 0.1))
n.samples<-30000
n.omp.threads<-1
n.report<-6000
n.burn<-10000
n.thin<-50
n.chains<-3
```

### setting up our model statements

```{r, eval = FALSE}

bbs_occobject_three$occ.covs[,-(findCorrelation(cor(bbs_occobject_three$occ.covs),cutoff=0.6))]
landcomm_drop
vegecomm_drop

occ_null <- ~1
occ_vibifq <- ~ scale(vibifq)
occ_fqi <- ~ scale(fqi)
occ_tol <- ~ scale(tol_rel)
occ_sens <- ~ scale(sens_rel)
occ_ldi <- ~ scale(ldi)
occ_developed <- ~ scale(developed.x)
occ_senstol <- ~ scale(sens_rel)+scale(tol_rel)
occ_herb <- ~scale(carex)+scale(dicot)+scale(hydro)+scale(svp)+scale(monocots)
occ_structure <- ~ scale(canopy_dens)+scale(canopy_dom)+scale(subcanopy_dom)+scale(small_tree)+scale(perc_open)+scale(shrub)
occ_uncorland <- ~ scale(slope)+scale(aspect)+scale(closest.trail)+scale(ldi)+scale(developed.x)
occ_landrda<-~scale(ldi)+scale(slope)+scale(developed.x)
occ_uncorveg <- ~ scale(carex)+scale(dicot)+scale(shrub)+scale(hydro)+scale(svp)+scale(sens_rel)+scale(tol_rel)+scale(small_tree)+scale(subcanopy_dom)+scale(canopy_dens)+scale(canopy_dom)+scale(monocots)+scale(perc_open)
occ_rdastep<- ~scale(monocots)+scale(perc_open)+scale(dicot)+scale(svp)+scale(carex)+scale(canopy_dens)+scale(tol_rel)
occ_alluncor<-~scale(carex)+scale(dicot)+scale(shrub)+scale(hydro)+scale(svp)+scale(sens_rel)+scale(tol_rel)+scale(developed.x)+scale(ldi)+scale(small_tree)+scale(subcanopy_dom)+scale(canopy_dens)+scale(canopy_dom)+scale(monocots)+scale(perc_open)+scale(slope)+scale(aspect)+scale(closest.trail)
occ_landvegrda<-~scale(monocots)+scale(perc_open)+scale(developed.x)+scale(ldi)+scale(dicot)+scale(carex)+scale(tol_rel)+scale(canopy_dens)+scale(svp)





det_null <- ~1
det_null_randobs<- ~ 1 + I(1|observer)
det_day <- ~ scale(day) 
det_day_randobs <- ~ scale(day) + I(1|observer)
det_daytod<- ~ scale(day)+scale(tod)
det_daytod_randobs <- ~ scale(day)+scale(tod)+ I(1|observer)
det_daytodquad <- ~ scale(day)+scale(tod) +I(scale(day)^2)
det_daytodquad_randobs <- ~ scale(day)+scale(tod) +I(scale(day)^2) + I(1|observer)
det_season <- ~ scale(seasons)
det_season_randobs <- ~ scale(seasons) + I(1|observer)
det_dayyearseason <- ~ scale(dayyear) + scale(seasons) 
det_dayyearseason_randobs <- ~ scale(dayyear) + scale(seasons) + I(1|observer)
det_dayyeartodseason <- ~ scale(dayyear)+scale(tod)+scale(seasons)
det_dayyeartodseason_randobs <- ~ scale(dayyear)+scale(tod)+scale(seasons) + I(1|observer)
det_dayyeartodseason <- ~ scale(dayyear)+scale(tod)+scale(seasons)
det_dayyeartodseason_randobs <- ~ scale(dayyear)+scale(tod)+scale(seasons)+ I(1|observer)
det_dayyeartodseasonroad <- ~ scale(dayyear)+scale(tod)+scale(seasons)+scale(dist_road)
det_dayyeartodseasonroad_randobs <- ~ scale(dayyear)+scale(tod)+scale(seasons)+scale(dist_road)+I(1|observer)

```

### basic null model

```{r, eval = FALSE}

out.ms.null.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_null, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.null.three)
#ppc.out.ms.null.three <- ppcOcc(out.ms.null.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.null.three)

```

### basic null model - with random effect

```{r, eval = FALSE}
out.ms.nullobs.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_null_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.nullobs.three)
#ppc.out.ms.nullobs.three <- ppcOcc(out.ms.nullobs.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.nullobs.three)

```

### building up complexity of detection model - just day for now

```{r, eval = FALSE}
out.ms.det.day.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_day, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


#summary(out.ms.det.day.three)
#ppc.out.ms.det.day.three <- ppcOcc(out.ms.det.day.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.day.three)


```


### day and random effect

```{r, eval = FALSE}
out.ms.detobs.day.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_day_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


#summary(out.ms.detobs.day.three)
#ppc.out.ms.detobs.day.three <- ppcOcc(out.ms.detobs.day.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.day.three)



```

### day and time-of-day

```{r, eval = FALSE}
out.ms.det.daytod.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_daytod, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.daytod.three)
#ppc.out.ms.det.daytod.three <- ppcOcc(out.ms.det.daytod.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.daytod.three)

```

### day and time-of-day - random observer

```{r, eval = FALSE}
out.ms.detobs.daytod.three <- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_daytod_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.daytod.three)
#ppc.out.ms.detobs.daytod.three <- ppcOcc(out.ms.detobs.daytod.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.daytod.three)

```

### day, tod, quadratic day

```{r, eval = FALSE}
out.ms.det.daytodquad.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_daytodquad, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.daytodquad.three)
#ppc.out.ms.det.daytodquad.three <- ppcOcc(out.ms.det.daytodquad.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.daytodquad.three)

```

### day, tod, quadratic day - random observer

```{r, eval = FALSE}
out.ms.detobs.daytodquad.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_daytodquad_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.daytodquad.three)
#ppc.out.ms.detobs.daytodquad.three <- ppcOcc(out.ms.detobs.daytodquad.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.daytodquad.three)

```


### season alone

```{r, eval = FALSE}
out.ms.det.season.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_season, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.season.three)
#ppc.out.ms.det.season.three <- ppcOcc(out.ms.det.season.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.season.three)

```

### season alone - random observer

```{r, eval = FALSE}
out.ms.detobs.season.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_season_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.season.three)
#ppc.out.ms.detobs.season.three <- ppcOcc(out.ms.detobs.season.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.season.three)

```

### day of year and season

```{r, eval = FALSE}
out.ms.det.dayyearseason.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyearseason, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.dayyearseason.three)
#ppc.out.ms.det.dayyearseason.three <- ppcOcc(out.ms.det.dayyearseason.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.dayyearseason.three)

```

### day of year and season - random observer

```{r, eval = FALSE}
out.ms.detobs.dayyearseason.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyearseason_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.dayyearseason.three)
#ppc.out.ms.detobs.dayyearseason.three <- ppcOcc(out.ms.detobs.dayyearseason.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.dayyearseason.three)

```


### day in year, tod, season

```{r, eval = FALSE}
out.ms.det.dayyeartodseason.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyeartodseason, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.dayyeartodseason.three)
#ppc.out.ms.det.dayyeartodseason.three <- ppcOcc(out.ms.det.dayyeartodseason.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.dayyeartodseason.three)

```

### day in year, tod, season - random observer

```{r, eval = FALSE}
out.ms.detobs.dayyeartodseason.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyeartodseason_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.dayyeartodseason.three)
#ppc.out.ms.detobs.dayyeartodseason.three <- ppcOcc(out.ms.detobs.dayyeartodseason.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.dayyeartodseason.three)

```


### day in year, tod, season, and roads

```{r, eval = FALSE}
out.ms.det.dayyeartodseasonroad.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyeartodseasonroad, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.det.dayyeartodseasonroad.three)
#ppc.out.ms.det.dayyeartodseasonroad.three <- ppcOcc(out.ms.det.dayyeartodseasonroad.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.det.dayyeartodseasonroad.three)

```

### day in year, tod, season - random observer

```{r, eval = FALSE}
out.ms.detobs.dayyeartodseasonroad.three<- msPGOcc(occ.formula = occ_null, 
                  det.formula = det_dayyeartodseasonroad_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
#summary(out.ms.detobs.dayyeartodseasonroad.three)
#ppc.out.ms.detobs.dayyeartodseasonroad.three <- ppcOcc(out.ms.detobs.dayyeartodseasonroad.three, 'freeman-tukey', group = 1)
#summary(ppc.out.ms.detobs.dayyeartodseasonroad.three)

```


### selecting fixed effects detection model

```{r, eval = FALSE}
det1<-waicOcc(out.ms.null.three)
det2<-waicOcc(out.ms.det.day.three)
det3<-waicOcc(out.ms.det.daytod.three)
det4<-waicOcc(out.ms.det.daytodquad.three)
det5<-waicOcc(out.ms.det.season.three)
det6<-waicOcc(out.ms.det.dayyearseason.three)
det7<-waicOcc(out.ms.det.dayyeartodseason.three)
det8<-waicOcc(out.ms.det.dayyeartodseasonroad.three)


```

### selecting random effect detection model

```{r, eval = FALSE}

detobs1<-waicOcc(out.ms.null.three)
detobs2<-waicOcc(out.ms.detobs.day.three)
detobs3<-waicOcc(out.ms.detobs.daytod.three)
detobs4<-waicOcc(out.ms.detobs.daytodquad.three)
detobs5<-waicOcc(out.ms.detobs.season.three)
detobs6<-waicOcc(out.ms.detobs.dayyearseason.three)
detobs7<-waicOcc(out.ms.detobs.dayyeartodseason.three)
detobs8<-waicOcc(out.ms.detobs.dayyeartodseasonroad.three)
save.image(file="rerunning_occ_models_12272022.RData")
```

The best-supported model is day of year, time of day, season, and distance to road. Thus, we will proceed with that one for now.

Now we will run several different occupancy submodels, once again evaluating fit for progressively more complicated models.

### occupancy model with vibi-fq

```{r, eval = FALSE}

out.ms.vibifq <- msPGOcc(occ.formula = occ_vibifq, 
                  det.formula = det_dayyeartodseasonroad_randobs, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.vibifq)
ppc.out.ms.vibifq <- ppcOcc(out.ms.vibifq, 'freeman-tukey', group = 1)
summary(ppc.out.ms.vibifq)

waicOcc(out.ms.vibifq)

```

### just FQAI

```{r, eval = FALSE}
out.ms.fqi <- msPGOcc(occ.formula = occ_fqi, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.fqi)
ppc.out.ms.fqi <- ppcOcc(out.ms.fqi, 'freeman-tukey', group = 1)
summary(ppc.out.ms.fqi)

waicOcc(out.ms.fqi)

```


### just tolerance

```{r, eval = FALSE}
out.ms.tol <- msPGOcc(occ.formula = occ_tol, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.tol)
ppc.out.ms.tol <- ppcOcc(out.ms.tol, 'freeman-tukey', group = 1)
summary(ppc.out.ms.tol)

waicOcc(out.ms.tol)

```

### just sensitivity

```{r, eval = FALSE}
out.ms.sens <- msPGOcc(occ.formula = occ_sens, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.sens)
ppc.out.ms.sens <- ppcOcc(out.ms.sens, 'freeman-tukey', group = 1)
summary(ppc.out.ms.sens)

waicOcc(out.ms.sens)

```

### just ldi

```{r, eval = FALSE}
out.ms.ldi <- msPGOcc(occ.formula = occ_ldi, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.ldi)
ppc.out.ms.ldi <- ppcOcc(out.ms.ldi, 'freeman-tukey', group = 1)
summary(ppc.out.ms.ldi)

waicOcc(out.ms.ldi)

```


### just developed

```{r, eval = FALSE}
out.ms.developed <- msPGOcc(occ.formula = occ_developed, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.developed)
ppc.out.ms.developed <- ppcOcc(out.ms.developed, 'freeman-tukey', group = 1)
summary(ppc.out.ms.developed)

waicOcc(out.ms.developed)

```

### just sensitive and tolerance

```{r, eval = FALSE}
out.ms.senstol <- msPGOcc(occ.formula = occ_senstol, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)
summary(out.ms.senstol)
ppc.out.ms.senstol <- ppcOcc(out.ms.senstol, 'freeman-tukey', group = 1)
summary(ppc.out.ms.senstol)

waicOcc(out.ms.senstol)

```

### herbaceous 

```{r, eval = FALSE}

out.ms.herb <- msPGOcc(occ.formula = occ_herb, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.herb)
ppc.out.ms.herb <- ppcOcc(out.ms.herb, 'freeman-tukey', group = 1)
summary(ppc.out.ms.herb)

waicOcc(out.ms.herb)

```

### structure 

```{r, eval = FALSE}

out.ms.structure <- msPGOcc(occ.formula = occ_structure, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.structure)
ppc.out.ms.structure <- ppcOcc(out.ms.structure, 'freeman-tukey', group = 1)
summary(ppc.out.ms.structure)

waicOcc(out.ms.structure)

```

### uncorrelated landscape variables 

```{r, eval = FALSE}

out.ms.uncorland <- msPGOcc(occ.formula = occ_uncorland, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.uncorland)
ppc.out.ms.uncorland <- ppcOcc(out.ms.uncorland, 'freeman-tukey', group = 1)
summary(ppc.out.ms.uncorland)

waicOcc(out.ms.uncorland)

```

### landscape variable - RDA supported

```{r, eval = FALSE}

out.ms.landrda<- msPGOcc(occ.formula = occ_landrda, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.landrda)
ppc.out.ms.landrda <- ppcOcc(out.ms.landrda, 'freeman-tukey', group = 1)
summary(ppc.out.ms.landrda)

waicOcc(out.ms.landrda)

```

### Uncorrelated vegetation variables - not positive definite

```{r, eval = FALSE}

out.ms.uncorveg<- msPGOcc(occ.formula = occ_uncorveg, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.uncorveg)
ppc.out.ms.uncorveg <- ppcOcc(out.ms.uncorveg, 'freeman-tukey', group = 1)
summary(ppc.out.ms.uncorveg)

waicOcc(out.ms.uncorveg)

```

### RDA supported vegetation covariates

```{r, eval = FALSE}

out.ms.rdastep<- msPGOcc(occ.formula = occ_rdastep, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.rdastep)
ppc.out.ms.rdastep <- ppcOcc(out.ms.rdastep, 'freeman-tukey', group = 1)
summary(ppc.out.ms.rdastep)

waicOcc(out.ms.rdastep)

```



### all RDA-supported covariates

```{r, eval = FALSE}

out.ms.landvegrda<- msPGOcc(occ.formula = occ_landvegrda, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = n.samples, 
                  priors = ms.priors, 
                  n.omp.threads = n.omp.threads, 
                  verbose = TRUE, 
                  n.report = n.report, 
                  n.burn = n.burn,
                  n.thin = n.thin, 
                  n.chains = n.chains)


summary(out.ms.landvegrda)
ppc.out.ms.landvegrda <- ppcOcc(out.ms.landvegrda, 'freeman-tukey', group = 1)
summary(ppc.out.ms.landvegrda)

waicOcc(out.ms.landvegrda)

```


### writing out this model

```{r, eval = FALSE}

write_rds(out.ms.landvegrda,"G:/NaturalResources/Byer/datasets/BBS/out.ms.fulllandveg.rds")

```

### model selection

we can also print out a table of Widely Applicable Information Criterion (wAIC) values. The lower this is, the better the model fit.

```{r, eval = FALSE,out.width="200%"}
AICc_table<-tibble(.rows = 9)

AICc_table$model<-c("Null", "p ~ day + tod + season + dist_roads, psi ~ tol_rel + svp + dicot + cyper + small_tree + shrub + hydro + subcanopy + canopy", "p ~ day + tod + season + dist_roads, psi ~ tol_rel + svp + dicot + cyper + ldi + developed","p ~ day + tod + season + dist_roads, psi ~ developed + activityarea + sanctionedtrail + bootlegtrail + streamedge + ldi","p ~ day + tod + season + dist_roads,psi~tol_rel + svp + dicot + cyper + small_tree","p ~ day + tod + season + dist_roads,psi~canopy + subcanopy + small_tree","p ~ day + tod + season + dist_roads,psi~tol_rel","p ~ day + tod + season + dist_roads,psi~vibi","p ~ day + tod + season + dist_roads,psi~vibi_notrees")

AICc_table$wAIC<-c(waicOcc(out.ms.nullobs)[[3]],waicOcc(out.ms.allveg)[[3]],waicOcc(out.ms.fulllandveg)[[3]],waicOcc(out.ms.land)[[3]],waicOcc(out.ms.rdaveg)[[3]],
                   waicOcc(out.ms.structure)[[3]],waicOcc(out.ms.tolerance)[[3]],waicOcc(out.ms.vibifq)[[3]],waicOcc(out.ms.vibifqnotrees)[[3]])

```

```{r, echo = FALSE,out.width="200%"}

AICc_table<-read.csv("G:/NaturalResources/Byer/datasets/BBS/wAIC_table_revise_1027.csv")
AICc_table_2<-AICc_table[,-1]

knitr::kable(AICc_table_2[order(AICc_table_2$wAIC),])
```

So, the top model is the model with a mix of land cover and vegetation covariates!

Now, we plot based on this top model - after running it for a bit longer.

```{r, eval = FALSE}
out.ms.landvegrda_2 <- msPGOcc(occ.formula = occ_landvegrda, 
                  det.formula = det_best, 
                  data = bbs_occobject_three, 
                  inits = ms.inits, 
                  n.samples = 200000, 
                  priors = ms.priors, 
                  n.omp.threads = 4, 
                  verbose = TRUE, 
                  n.report = 10000, 
                  n.burn = 10000,
                  n.thin = 100, 
                  n.chains = n.chains)


summary(out.ms.landvegrda_2)
ppc.out.ms.landvegrda_2 <- ppcOcc(out.ms.landvegrda_2, 'freeman-tukey', group = 1)
summary(ppc.out.ms.landvegrda_2)

waicOcc(out.ms.landvegrda_2)

write_rds(out.ms.landvegrda_2,"G:/NaturalResources/Byer/datasets/BBS/out.ms.landvegrda_2.rds")

out.ms.landvegrda_2<-read_rds("G:/NaturalResources/Byer/datasets/BBS/out.ms.landvegrda_2.rds")

```

### plot single covariate effects

```{r,eval=FALSE,echo=FALSE}

#out.ms.fulllandveg_2<-read_rds("G:/NaturalResources/Byer/datasets/BBS/out.ms.fulllandveg_2.rds")

#out.ms.landvegrda


X.0.dat<-as.data.frame(bbs_occobject_three$occ.covs) %>%
  dplyr::select(monocots, perc_open, developed.x, ldi, dicot, carex,
                tol_rel,canopy_dens,svp)
X.0.dat<-cbind(1,X.0.dat)


monocots_pred<-seq(min(X.0.dat$monocots), max(X.0.dat$monocots), by = (max(X.0.dat$monocots)-min(X.0.dat$monocots))/97)
perc_open_pred<-seq(min(X.0.dat$perc_open), max(X.0.dat$perc_open), by = (max(X.0.dat$perc_open)-min(X.0.dat$perc_open))/97)
developed_pred<-seq(min(X.0.dat$developed.x), max(X.0.dat$developed.x), by = (max(X.0.dat$developed.x)-min(X.0.dat$developed.x))/97)
ldi_pred<-seq(min(X.0.dat$ldi), max(X.0.dat$ldi), by = (max(X.0.dat$ldi)-min(X.0.dat$ldi))/97)
dicot_pred<-seq(min(X.0.dat$dicot), max(X.0.dat$dicot), by = (max(X.0.dat$dicot)-min(X.0.dat$dicot))/97)
carex_pred<-seq(min(X.0.dat$carex), max(X.0.dat$carex), by = (max(X.0.dat$carex)-min(X.0.dat$carex))/97)
tol_rel_pred<-seq(min(X.0.dat$tol_rel), max(X.0.dat$tol_rel), by = (max(X.0.dat$tol_rel)-min(X.0.dat$tol_rel))/97)
canopy_dens_pred<-seq(min(X.0.dat$canopy_dens), max(X.0.dat$canopy_dens), by = (max(X.0.dat$canopy_dens)-min(X.0.dat$canopy_dens))/97)
svp_pred<-seq(min(X.0.dat$svp), max(X.0.dat$svp), by = (max(X.0.dat$svp)-min(X.0.dat$svp))/97)



monocots.pred <- (monocots_pred - mean(bbs_occobject_three$occ.covs[, 20])) / sd(bbs_occobject_three$occ.covs[, 20])
perc_open.pred <- (perc_open_pred - mean(bbs_occobject_three$occ.covs[, 21])) / sd(bbs_occobject_three$occ.covs[, 21])
developed.pred <- (developed_pred - mean(bbs_occobject_three$occ.covs[, 11])) / sd(bbs_occobject_three$occ.covs[, 11])
ldi.pred <- (ldi_pred - mean(bbs_occobject_three$occ.covs[, 12])) / sd(bbs_occobject_three$occ.covs[, 12])
dicot.pred <- (dicot_pred - mean(bbs_occobject_three$occ.covs[, 3])) / sd(bbs_occobject_three$occ.covs[, 3])
carex.pred <- (carex_pred - mean(bbs_occobject_three$occ.covs[, 2])) / sd(bbs_occobject_three$occ.covs[, 2])
tolrel.pred <- (tol_rel_pred - mean(bbs_occobject_three$occ.covs[, 10])) / sd(bbs_occobject_three$occ.covs[, 10])
canopy_dens.pred <- (canopy_dens_pred - mean(bbs_occobject_three$occ.covs[, 17])) / sd(bbs_occobject_three$occ.covs[, 17])
svp.pred <- (svp_pred - mean(bbs_occobject_three$occ.covs[,7])) / sd(bbs_occobject_three$occ.covs[,7])


occu_monocots_newdata <- data.frame(int=1,
                                    monocots=monocots.pred,
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
                                    
occu_percopen_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=perc_open.pred,
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)

occu_developed_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=developed.pred,
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_ldi_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=ldi.pred,
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_dicot_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=dicot.pred,
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_carex_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=carex.pred,
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_tolrel_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=tolrel.pred,
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_canopydens_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=canopy_dens.pred,
                                    svp=mean(bbs_occobject_three$occ.covs[,7]) / sd(bbs_occobject_three$occ.covs[,7])
)
occu_svp_newdata <- data.frame(int=1,
                                    monocots=mean(bbs_occobject_three$occ.covs[, 20]) / sd(bbs_occobject_three$occ.covs[, 20]),
                                    perc_open=mean(bbs_occobject_three$occ.covs[, 21]) / sd(bbs_occobject_three$occ.covs[, 21]),
                                    developed.x=mean(bbs_occobject_three$occ.covs[, 11]) / sd(bbs_occobject_three$occ.covs[, 11]),
                                    ldi=mean(bbs_occobject_three$occ.covs[, 12]) / sd(bbs_occobject_three$occ.covs[, 12]),
                                    dicot=mean(bbs_occobject_three$occ.covs[, 3]) / sd(bbs_occobject_three$occ.covs[, 3]),
                                    carex=mean(bbs_occobject_three$occ.covs[, 2]) / sd(bbs_occobject_three$occ.covs[, 2]),
                                    tol_rel=mean(bbs_occobject_three$occ.covs[, 10]) / sd(bbs_occobject_three$occ.covs[, 10]),
                                    canopy_dens=mean(bbs_occobject_three$occ.covs[, 17]) / sd(bbs_occobject_three$occ.covs[, 17]),
                                    svp=svp.pred
)

monocotpred<-predict(out.ms.landvegrda_2,as.matrix(occu_monocots_newdata))

percopenpred<-predict(out.ms.landvegrda_2,as.matrix(occu_percopen_newdata))

developedpred<-predict(out.ms.landvegrda_2,as.matrix(occu_developed_newdata))

ldipred<-predict(out.ms.landvegrda_2,as.matrix(occu_ldi_newdata))

dicotpred<-predict(out.ms.landvegrda_2,as.matrix(occu_dicot_newdata))

carexpred<-predict(out.ms.landvegrda_2,as.matrix(occu_carex_newdata))

tolrelpred<-predict(out.ms.landvegrda_2,as.matrix(occu_tolrel_newdata))

canopydenspred<-predict(out.ms.landvegrda_2,as.matrix(occu_canopydens_newdata))

svppred<-predict(out.ms.landvegrda_2,as.matrix(occu_svp_newdata))


occu_monocots_newdata$meanpsi<-apply(monocotpred$psi.0.samples[,,], 3, mean)

occu_monocots_newdata$sdpsi<-apply(monocotpred$psi.0.samples[,,], 3, sd)

occu_monocots_newdata$meanpsi_R<-apply(monocotpred$psi.0.samples[,c(9,14,27,37,48,51,54,55,63,69,75,77,78,85,88,93,96),], 3, mean)

occu_monocots_newdata$sdpsi_R<-apply(monocotpred$psi.0.samples[,c(9,14,27,37,48,51,54,55,63,69,75,77,78,85,88,93,96),], 3, sd)

occu_monocots_newdata$meanpsi_T<-apply(monocotpred$psi.0.samples[,c(1,2,6,11,12,13,18,20,23,24,25,29,31,32,35,39,43,47,53,56,58,60,65,66,67,68,71,72,76,81,84,87,90,92,94,95,99,100,101,102,103),], 3, mean)

occu_monocots_newdata$sdpsi_T<-apply(monocotpred$psi.0.samples[,c(1,2,6,11,12,13,18,20,23,24,25,29,31,32,35,39,43,47,53,56,58,60,65,66,67,68,71,72,76,81,84,87,90,92,94,95,99,100,101,102,103),], 3, sd)

occu_monocots_newdata$meanpsi_S<-apply(monocotpred$psi.0.samples[,c(3,4,5,7,8,10,15,16,17,19,21,22,26,28,30,33,34,36,38,40,41,42,44,45,46,49,50,52,57,59,61,62,64,70,73,74,79,80,82,83,86,89,91,97,98),], 3, mean)

occu_monocots_newdata$sdpsi_S<-apply(monocotpred$psi.0.samples[,c(3,4,5,7,8,10,15,16,17,19,21,22,26,28,30,33,34,36,38,40,41,42,44,45,46,49,50,52,57,59,61,62,64,70,73,74,79,80,82,83,86,89,91,97,98),], 3, sd)

occu_monocots_newdata$meanpsi_R<-apply(monocotpred$psi.0.samples[,,], 3, mean)

occu_monocots_newdata$sdpsi_R<-apply(monocotpred$psi.0.samples[,,], 3, sd)

occu_percopen_newdata$meanpsi<-apply(percopenpred$psi.0.samples[,,], 3, mean)

occu_percopen_newdata$sdpsi<-apply(percopenpred$psi.0.samples[,,], 3, sd)

occu_percopen_newdata$meanpsi_R<-apply(percopenpred$psi.0.samples[,c(9,14,27,37,48,51,54,55,63,69,75,77,78,85,88,93,96),], 3, mean)

occu_percopen_newdata$sdpsi_R<-apply(percopenpred$psi.0.samples[,c(9,14,27,37,48,51,54,55,63,69,75,77,78,85,88,93,96),], 3, sd)

occu_percopen_newdata$meanpsi_T<-apply(percopenpred$psi.0.samples[,c(1,2,6,11,12,13,18,20,23,24,25,29,31,32,35,39,43,47,53,56,58,60,65,66,67,68,71,72,76,81,84,87,90,92,94,95,99,100,101,102,103),], 3, mean)

occu_percopen_newdata$sdpsi_T<-apply(percopenpred$psi.0.samples[,c(1,2,6,11,12,13,18,20,23,24,25,29,31,32,35,39,43,47,53,56,58,60,65,66,67,68,71,72,76,81,84,87,90,92,94,95,99,100,101,102,103),], 3, sd)

occu_percopen_newdata$meanpsi_S<-apply(percopenpred$psi.0.samples[,c(3,4,5,7,8,10,15,16,17,19,21,22,26,28,30,33,34,36,38,40,41,42,44,45,46,49,50,52,57,59,61,62,64,70,73,74,79,80,82,83,86,89,91,97,98),], 3, mean)

occu_percopen_newdata$sdpsi_S<-apply(percopenpred$psi.0.samples[,c(3,4,5,7,8,10,15,16,17,19,21,22,26,28,30,33,34,36,38,40,41,42,44,45,46,49,50,52,57,59,61,62,64,70,73,74,79,80,82,83,86,89,91,97,98),], 3, sd)

occu_developed_newdata$meanpsi<-apply(developedpred$psi.0.samples[,,], 3, mean)

occu_developed_newdata$sdpsi<-apply(developedpred$psi.0.samples[,,], 3, sd)

occu_ldi_newdata$meanpsi<-apply(ldipred$psi.0.samples[,,], 3, mean)

occu_ldi_newdata$sdpsi<-apply(ldipred$psi.0.samples[,,], 3, sd)

occu_dicot_newdata$meanpsi<-apply(dicotpred$psi.0.samples[,,], 3, mean)

occu_dicot_newdata$sdpsi<-apply(dicotpred$psi.0.samples[,,], 3, sd)

occu_carex_newdata$meanpsi<-apply(carexpred$psi.0.samples[,,], 3, mean)

occu_carex_newdata$sdpsi<-apply(carexpred$psi.0.samples[,,], 3, sd)

occu_tolrel_newdata$meanpsi<-apply(tolrelpred$psi.0.samples[,,], 3, mean)

occu_tolrel_newdata$sdpsi<-apply(tolrelpred$psi.0.samples[,,], 3, sd)

occu_canopydens_newdata$meanpsi<-apply(canopydenspred$psi.0.samples[,,], 3, mean)

occu_canopydens_newdata$sdpsi<-apply(canopydenspred$psi.0.samples[,,], 3, sd)

occu_svp_newdata$meanpsi<-apply(svppred$psi.0.samples[,,], 3, mean)

occu_svp_newdata$sdpsi<-apply(svppred$psi.0.samples[,,], 3, sd)

occu_tolrel_newdata$meanpsi_ACFL<-apply(tolrelpred$psi.0.samples[,1,], 2, mean)

occu_tolrel_newdata$sdpsi_ACFL<-apply(tolrelpred$psi.0.samples[,1,], 2, sd)

occu_ldi_newdata$meanpsi_ACFL<-apply(ldipred$psi.0.samples[,1,], 2, mean)

occu_ldi_newdata$sdpsi_ACFL<-apply(ldipred$psi.0.samples[,1,], 2, sd)

occu_svp_newdata$meanpsi_ACFL<-apply(svppred$psi.0.samples[,1,], 2, mean)

occu_svp_newdata$sdpsi_ACFL<-apply(svppred$psi.0.samples[,1,], 2, sd)

occu_tolrel_newdata$meanpsi_HOWA<-apply(tolrelpred$psi.0.samples[,56,], 2, mean)

occu_tolrel_newdata$sdpsi_HOWA<-apply(tolrelpred$psi.0.samples[,56,], 2, sd)

occu_ldi_newdata$meanpsi_HOWA<-apply(ldipred$psi.0.samples[,56,], 2, mean)

occu_ldi_newdata$sdpsi_HOWA<-apply(ldipred$psi.0.samples[,56,], 2, sd)

occu_svp_newdata$meanpsi_HOWA<-apply(svppred$psi.0.samples[,56,], 2, mean)

occu_svp_newdata$sdpsi_HOWA<-apply(svppred$psi.0.samples[,56,], 2, sd)

occu_tolrel_newdata$meanpsi_PIWO<-apply(tolrelpred$psi.0.samples[,69,], 2, mean)

occu_tolrel_newdata$sdpsi_PIWO<-apply(tolrelpred$psi.0.samples[,69,], 2, sd)

occu_ldi_newdata$meanpsi_PIWO<-apply(ldipred$psi.0.samples[,69,], 2, mean)

occu_ldi_newdata$sdpsi_PIWO<-apply(ldipred$psi.0.samples[,69,], 2, sd)

occu_svp_newdata$meanpsi_PIWO<-apply(svppred$psi.0.samples[,69,], 2, mean)

occu_svp_newdata$sdpsi_PIWO<-apply(svppred$psi.0.samples[,69,], 2, sd)

occu_tolrel_newdata$meanpsi_SOSP<-apply(tolrelpred$psi.0.samples[,85,], 2, mean)

occu_tolrel_newdata$sdpsi_SOSP<-apply(tolrelpred$psi.0.samples[,85,], 2, sd)

occu_ldi_newdata$meanpsi_SOSP<-apply(ldipred$psi.0.samples[,85,], 2, mean)

occu_ldi_newdata$sdpsi_SOSP<-apply(ldipred$psi.0.samples[,85,], 2, sd)

occu_svp_newdata$meanpsi_SOSP<-apply(svppred$psi.0.samples[,85,], 2, mean)

occu_svp_newdata$sdpsi_SOSP<-apply(svppred$psi.0.samples[,85,], 2, sd)


occu_tolrel_newdata$meanpsi_GRCA<-apply(tolrelpred$psi.0.samples[,49,], 2, mean)

occu_tolrel_newdata$sdpsi_GRCA<-apply(tolrelpred$psi.0.samples[,49,], 2, sd)

occu_ldi_newdata$meanpsi_GRCA<-apply(ldipred$psi.0.samples[,49,], 2, mean)

occu_ldi_newdata$sdpsi_GRCA<-apply(ldipred$psi.0.samples[,49,], 2, sd)

occu_svp_newdata$meanpsi_GRCA<-apply(svppred$psi.0.samples[,49,], 2, mean)

occu_svp_newdata$sdpsi_GRCA<-apply(svppred$psi.0.samples[,49,], 2, sd)

occu_tolrel_newdata$meanpsi_BGGN<-apply(tolrelpred$psi.0.samples[,16,], 2, mean)

occu_tolrel_newdata$sdpsi_BGGN<-apply(tolrelpred$psi.0.samples[,16,], 2, sd)

occu_ldi_newdata$meanpsi_BGGN<-apply(ldipred$psi.0.samples[,16,], 2, mean)

occu_ldi_newdata$sdpsi_BGGN<-apply(ldipred$psi.0.samples[,16,], 2, sd)

occu_svp_newdata$meanpsi_BGGN<-apply(svppred$psi.0.samples[,16,], 2, mean)

occu_svp_newdata$sdpsi_BGGN<-apply(svppred$psi.0.samples[,16,], 2, sd)

occu_tolrel_newdata$meanpsi_AMGO<-apply(tolrelpred$psi.0.samples[,4,], 2, mean)

occu_tolrel_newdata$sdpsi_AMGO<-apply(tolrelpred$psi.0.samples[,4,], 2, sd)

occu_ldi_newdata$meanpsi_AMGO<-apply(ldipred$psi.0.samples[,4,], 2, mean)

occu_ldi_newdata$sdpsi_AMGO<-apply(ldipred$psi.0.samples[,4,], 2, sd)

occu_svp_newdata$meanpsi_AMGO<-apply(svppred$psi.0.samples[,4,], 2, mean)

occu_svp_newdata$sdpsi_AMGO<-apply(svppred$psi.0.samples[,4,], 2, sd)

occu_tolrel_newdata$meanpsi_BHCO<-apply(tolrelpred$psi.0.samples[,17,], 2, mean)

occu_tolrel_newdata$sdpsi_BHCO<-apply(tolrelpred$psi.0.samples[,17,], 2, sd)

occu_ldi_newdata$meanpsi_BHCO<-apply(ldipred$psi.0.samples[,17,], 2, mean)

occu_ldi_newdata$sdpsi_BHCO<-apply(ldipred$psi.0.samples[,17,], 2, sd)

occu_svp_newdata$meanpsi_BHCO<-apply(svppred$psi.0.samples[,17,], 2, mean)

occu_svp_newdata$sdpsi_BHCO<-apply(svppred$psi.0.samples[,17,], 2, sd)


sppnames

write_rds(occu_monocots_newdata,"occu_monocots_newdata.rds")

write_rds(occu_percopen_newdata,"occu_percopen_newdata.rds")

write_rds(occu_developed_newdata,"occu_developed_newdata.rds")

write_rds(occu_ldi_newdata,"occu_ldi_newdata.rds")

write_rds(occu_dicot_newdata,"occu_dicot_newdata.rds")

write_rds(occu_carex_newdata,"occu_carex_newdata.rds")

write_rds(occu_tolrel_newdata,"occu_tolrel_newdata.rds")

write_rds(occu_canopydens_newdata,"occu_canopydens_newdata.rds")

write_rds(occu_svp_newdata,"occu_svp_newdata.rds")

```

```{r,echo=FALSE}

occu_ldi_newdata<-read_rds("G:/NaturalResources/Byer/datasets/BBS/occu_ldi_newdata.rds")
occu_tolrel_newdata<-read_rds("G:/NaturalResources/Byer/datasets/BBS/occu_tolrel_newdata.rds")
occu_svp_newdata<-read_rds("G:/NaturalResources/Byer/datasets/BBS/occu_svp_newdata.rds")

allocc_tolrelplot_2<-ggplot(aes(tol_rel,meanpsi),data=data.frame(occu_tolrel_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi - sdpsi, ymax = meanpsi + sdpsi),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Community-level Occupancy")+theme_classic(base_size=16)
allocc_tolrelplot_2

allocc_ldiplot_2<-ggplot(aes(ldi,meanpsi),data=data.frame(occu_ldi_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi - sdpsi, ymax = meanpsi + sdpsi),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+xlab("Landscape Development Index")+ylab("Community-level Occupancy")+theme_classic(base_size=16)
allocc_ldiplot_2


allocc_tolrelplot_ACFL<-ggplot(aes(tol_rel,meanpsi_ACFL),data=data.frame(occu_tolrel_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_ACFL - sdpsi_ACFL, ymax = meanpsi_ACFL + sdpsi_ACFL),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Acadian Flycatcher Occupancy")
allocc_tolrelplot_ACFL

allocc_ldiplot_ACFL<-ggplot(aes(ldi,meanpsi_ACFL),data=data.frame(occu_ldi_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_ACFL - sdpsi_ACFL, ymax = meanpsi_ACFL + sdpsi_ACFL),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Acadian Flycatcher Occupancy")
allocc_ldiplot_ACFL

allocc_tolrelplot_HOWA<-ggplot(aes(tol_rel,meanpsi_HOWA),data=data.frame(occu_tolrel_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_HOWA - sdpsi_HOWA, ymax = meanpsi_HOWA + sdpsi_HOWA),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Hooded Warbler Occupancy")
allocc_tolrelplot_HOWA

allocc_ldiplot_HOWA<-ggplot(aes(ldi,meanpsi_HOWA),data=data.frame(occu_ldi_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_HOWA - sdpsi_HOWA, ymax = meanpsi_HOWA + sdpsi_HOWA),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Hooded Warbler Occupancy")
allocc_ldiplot_HOWA

allocc_tolrelplot_PIWO<-ggplot(aes(tol_rel,meanpsi_PIWO),data=data.frame(occu_tolrel_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_PIWO - sdpsi_PIWO, ymax = meanpsi_PIWO + sdpsi_PIWO),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Pileated Woodpecker Occupancy")
allocc_tolrelplot_PIWO

allocc_ldiplot_PIWO<-ggplot(aes(ldi,meanpsi_PIWO),data=data.frame(occu_ldi_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_PIWO - sdpsi_PIWO, ymax = meanpsi_PIWO + sdpsi_PIWO),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Pileated Woodpecker Occupancy")
allocc_ldiplot_PIWO

allocc_tolrelplot_SOSP<-ggplot(aes(tol_rel,meanpsi_SOSP),data=data.frame(occu_tolrel_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_SOSP - sdpsi_SOSP, ymax = meanpsi_SOSP + sdpsi_SOSP),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Song Sparrow Occupancy")
allocc_tolrelplot_SOSP

allocc_ldiplot_SOSP<-ggplot(aes(ldi,meanpsi_SOSP),data=data.frame(occu_ldi_newdata))+geom_line()+geom_ribbon(aes(ymin = meanpsi_SOSP - sdpsi_SOSP, ymax = meanpsi_SOSP + sdpsi_SOSP),alpha=0.5,fill="grey70")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Song Sparrow Occupancy")
allocc_ldiplot_SOSP



allocc_ldiplot_allspp<-ggplot(aes(ldi,meanpsi_SOSP),data=data.frame(occu_ldi_newdata))+geom_line(col="tan4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_SOSP - sdpsi_SOSP, ymax = meanpsi_SOSP + sdpsi_SOSP),alpha=0.1,fill="tan2")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Occupancy")+geom_line(aes(ldi,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_ACFL - sdpsi_ACFL, ymax = meanpsi_ACFL + sdpsi_ACFL),alpha=0.1,fill="springgreen2")+geom_line(aes(ldi,meanpsi_PIWO),col="red4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_PIWO - sdpsi_PIWO, ymax = meanpsi_PIWO + sdpsi_PIWO),alpha=0.1,fill="red2")+geom_line(aes(ldi,meanpsi_HOWA),col="gold4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_HOWA - sdpsi_HOWA, ymax = meanpsi_HOWA + sdpsi_HOWA),alpha=0.1,fill="gold2")

allocc_ldiplot_allspp

<<<<<<<< HEAD:bbs_cmp_bin_sub.Rmd
allocc_ldiplot_allspp_2<-ggplot(aes(ldi,meanpsi_SOSP),data=data.frame(occu_ldi_newdata))+geom_line(col="tan4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Occupancy")+geom_line(aes(ldi,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_line(aes(ldi,meanpsi_PIWO),col="red4",size=1.5)+geom_line(aes(ldi,meanpsi_HOWA),col="gold3",size=1.5)

allocc_ldiplot_allspp_2

allocc_ldiplot_shortmig_2<-ggplot(aes(ldi,meanpsi_AMGO),data=data.frame(occu_ldi_newdata))+geom_line(col="gold4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Occupancy")+geom_line(aes(ldi,meanpsi_BGGN),col="skyblue4",size=1.5)+geom_line(aes(ldi,meanpsi_BHCO),col="brown4",size=1.5)+geom_line(aes(ldi,meanpsi_GRCA),col="grey4",size=1.5)

allocc_ldiplot_shortmig_2

========
allocc_ldiplot_allspp_2<-ggplot(aes(ldi_3k,meanpsi_SOSP),data=data.frame(occu_ldi_newdata))+geom_line(col="tan4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Landscape Development Index")+ylab("Occupancy")+geom_line(aes(ldi_3k,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_line(aes(ldi_3k,meanpsi_PIWO),col="red4",size=1.5)+geom_line(aes(ldi_3k,meanpsi_HOWA),col="gold3",size=1.5)

allocc_ldiplot_allspp_2

>>>>>>>> 428d11ca61457c1db8950a8dfc5b38d9906569b4:bbs_cmp_bin.Rmd

allocc_tolrelplot_allspp<-ggplot(aes(tol_rel,meanpsi_SOSP),data=data.frame(occu_tolrel_newdata))+geom_line(col="tan4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_SOSP - sdpsi_SOSP, ymax = meanpsi_SOSP + sdpsi_SOSP),alpha=0.1,fill="tan2")+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Occupancy")+geom_line(aes(tol_rel,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_ACFL - sdpsi_ACFL, ymax = meanpsi_ACFL + sdpsi_ACFL),alpha=0.1,fill="springgreen2")+geom_line(aes(tol_rel,meanpsi_PIWO),col="red4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_PIWO - sdpsi_PIWO, ymax = meanpsi_PIWO + sdpsi_PIWO),alpha=0.1,fill="red2")+geom_line(aes(tol_rel,meanpsi_HOWA),col="gold4",size=1.5)+geom_ribbon(aes(ymin = meanpsi_HOWA - sdpsi_HOWA, ymax = meanpsi_HOWA + sdpsi_HOWA),alpha=0.1,fill="gold2")

allocc_tolrelplot_allspp


allocc_tolrelplot_allspp_2<-ggplot(aes(tol_rel,meanpsi_SOSP),data=data.frame(occu_tolrel_newdata))+geom_line(col="tan4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Occupancy")+geom_line(aes(tol_rel,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_line(aes(tol_rel,meanpsi_PIWO),col="red4",size=1.5)+geom_line(aes(tol_rel,meanpsi_HOWA),col="gold3",size=1.5)

allocc_tolrelplot_allspp_2

allocc_tol_relplot_shortmig_2<-ggplot(aes(tol_rel,meanpsi_AMGO),data=data.frame(occu_tolrel_newdata))+geom_line(col="gold4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Relative cover of tolerant plants")+ylab("Occupancy")+geom_line(aes(tol_rel,meanpsi_BGGN),col="skyblue4",size=1.5)+geom_line(aes(tol_rel,meanpsi_BHCO),col="brown4",size=1.5)+geom_line(aes(tol_rel,meanpsi_GRCA),col="grey4",size=1.5)

allocc_tol_relplot_shortmig_2



allocc_svpplot_allspp_2<-ggplot(aes(svp,meanpsi_SOSP),data=data.frame(occu_svp_newdata))+geom_line(col="tan4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Ferns")+ylab("Occupancy")+geom_line(aes(svp,meanpsi_ACFL),col="springgreen4",size=1.5)+geom_line(aes(svp,meanpsi_PIWO),col="red4",size=1.5)+geom_line(aes(svp,meanpsi_HOWA),col="gold3",size=1.5)

allocc_svpplot_allspp_2

<<<<<<<< HEAD:bbs_cmp_bin_sub.Rmd
allocc_svpplot_shortmig_2<-ggplot(aes(svp,meanpsi_AMGO),data=data.frame(occu_svp_newdata))+geom_line(col="gold4",size=1.5)+ylim(c(-0.1,1.1))+theme_classic(base_size=16)+xlab("Ferns")+ylab("Occupancy")+geom_line(aes(svp,meanpsi_BGGN),col="skyblue4",size=1.5)+geom_line(aes(svp,meanpsi_BHCO),col="brown4",size=1.5)+geom_line(aes(svp,meanpsi_GRCA),col="grey4",size=1.5)

allocc_svpplot_shortmig_2


========
>>>>>>>> 428d11ca61457c1db8950a8dfc5b38d9906569b4:bbs_cmp_bin.Rmd
```


```{r, echo = FALSE, eval = FALSE}
fitted.ms.fulllandveg<-fitted(out.ms.landvegrda)

sppnames<-c("ACFL","ALFL","AMCR","AMGO","AMKE","AMRE","AMRO","AMWO","BADO","BAEA",
"BANS","BAOR","BARS","BCCH","BEKI","BGGN","BHCO","BHVI","BLJA","BOBO","BRCR","BRTH","BTNW","BWHA",
"BWWA","CANG","CARW","CEDW","CERW","CHSP","CHSW","CLSW","COGR","COHA","COYE","DEJU","DOWO","EABL","EAKI","EAME",
"EAPH","EATO","EAWP","EUST","FISP","GBHE","GCFL","GHOW","GRCA","GRHE","HAWO","HERG","HETH","HOFI",
"HOSP","HOWA","HOWR","INBU","KILL","LOWA","MALL","MODO","NOCA","NOFL","NOPA",
"NRWS","OROR","OVEN","PIWO","PUFI","PUMA","RBGR","RBGU","RBNU","RBWO","REVI",
"RHWO","ROPI","RSHA","RTHA","RTHU","RWBL","SAVS","SCTA","SOSP","SWSP",
"TRES","TUTI","TUVU","VEER","VIRA","WAVI","WBNU",
"WEVI","WIFL","WITU","WIWR","WODU","WOTH","YBCU","YEWA","YTVI","YTWA")

#loop for just the 164 original points

idwrasters_landveg<-list()

for(i in 1:length(sppnames)){
  plot.dat.ms <- data.frame(x = bbs_occobject_three$coords[,1], 
                            y = bbs_occobject_three$coords[,2], 
                            mean.psi = apply(out.ms.landvegrda$psi.samples[,i,], 2, mean))
  
  dsp <- SpatialPoints(plot.dat.ms[,1:2])
  dsp <- SpatialPointsDataFrame(dsp, plot.dat.ms)
  # define groups for mapping
  cuts <- c(0,0.25,0.75,1.0)
  # set up a palette of interpolated colors
  blues <- colorRampPalette(c('yellow', 'orange', 'blue', 'dark blue'))
  spplot(dsp, 'mean.psi', cuts=cuts, col.regions=blues(5), pch=20, cex=2)
  v <- voronoi(dsp)
  
  ch <- chull(plot.dat.ms[,1:2])
  coords <- plot.dat.ms[c(ch, ch[1]), 1:2]  # closed polygon
  
  plot(plot.dat.ms[,1:2], pch=19)
  lines(coords, col="#E69F00" )
  
 
  
  sp_poly <- SpatialPolygons(list(Polygons(list(Polygon(coords)), ID=1)))
  # set coordinate reference system with SpatialPolygons(..., proj4string=CRS(...))
  # e.g. CRS("+proj=longlat +datum=WGS84")
  sp_poly_df <- SpatialPolygonsDataFrame(sp_poly, data=data.frame(ID=1))
  #writeOGR(sp_poly_df, "chull", layer="chull", driver="ESRI Shapefile")
  
  vca <- intersect(v, sp_poly_df)
  spplot(vca, 'mean.psi', col.regions=rev(get_col_regions()))
  r <- raster(sp_poly_df, res=5000)
#  crs(r)<-"+proj=longlat +datum=NAD83"
  vr <- rasterize(vca, r, 'mean.psi')
  plot(vr)
  points(dsp)
  
  writeRaster(vr,filename = paste0("U:/DataAnalysis/BreedingBirds/01132023predictions/",sppnames[i],"_occmeanpsi_fulllandveg_origbbslocs.asc"),overwrite=TRUE)
  
  fitmax <- gstat::gstat(formula = mean.psi ~ 1, data = dsp, nmax = 4, set = list(idp = .5))
  maxint <- raster::interpolate(r, model=fitmax, ext=vr)
  plot(maxint, col=rev(heat.colors(255)), ext=vr)
  plot(vr, add=TRUE)
  r2 <- crop(maxint, extent(sp_poly_df))
  r3 <- mask(r2, sp_poly_df)
  idwrasters_landveg[[i]]<-r3
  writeRaster(maxint,filename = paste0("U:/DataAnalysis/BreedingBirds/01132023predictions/",sppnames[i],"_occmeanpsi_fulllandveg_origbbslocs_idw.asc"),overwrite=TRUE)
}

saveRDS(idwrasters_landveg,"U:/DataAnalysis/BreedingBirds/idwrasters_fulllandveg.Rdata")

saveRDS(sppnames,"U:/DataAnalysis/BreedingBirds/sppnames.Rdata")


idwrasters_detection<-list()

p.samples.full<-apply(fitted.ms.fulllandveg$p.samples,c(1,2,3),FUN=mean,na.rm=TRUE)

respoly<-readOGR("G:/NaturalResources/Byer/DataAnalysis/bbs_cmp_analyses/bbsapp/CMPboundaries.shp")
RMSE <- function(observed, predicted) {
  sqrt(mean((predicted - observed)^2, na.rm=TRUE))
}
f1 <- function(x, test, train) {
  nmx <- x[1]
  idp <- x[2]
  if (nmx < 1) return(Inf)
  if (idp < .001) return(Inf)
  m <- gstat(formula=mean.psi~1, locations=train, nmax=nmx, set=list(idp=idp))
  p <- predict(m, newdata=test, debug.level=0)$var1.pred
  RMSE(test$mean.psi, p)
}

for(i in 1:length(sppnames)){
  plot.dat.ms <- data.frame(x = bbs_occobject_three$coords[,1], 
                            y = bbs_occobject_three$coords[,2], 
                            mean.psi = apply(p.samples.full[,i,], 2, mean))
  
  dsp <- SpatialPoints(plot.dat.ms[,1:2])
  dsp <- SpatialPointsDataFrame(dsp, plot.dat.ms)
  crs(dsp)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  j <- sample(nrow(dsp), 0.2 * nrow(dsp))
  tst <- dsp[j,]
  trn <- dsp[-j,]
opt <- optim(c(8, .5), f1, test=tst, train=trn)
  # define groups for mapping
  cuts <- c(0,0.25,0.75,1.0)
  # set up a palette of interpolated colors
  blues <- colorRampPalette(c('yellow', 'orange', 'blue', 'dark blue'))
  spplot(dsp, 'mean.psi', cuts=cuts, col.regions=blues(5), pch=20, cex=2)
  v <- voronoi(dsp)
   
  ch <- chull(plot.dat.ms[,1:2])
  coords <- plot.dat.ms[c(ch, ch[1]), 1:2]  # closed polygon
  
  plot(plot.dat.ms[,1:2], pch=19)
  lines(coords, col="#E69F00" )
  
 
  
  #sp_poly <- SpatialPolygons(list(Polygons(list(Polygon(coords)), ID=1)))
  # set coordinate reference system with SpatialPolygons(..., proj4string=CRS(...))
  # e.g. CRS("+proj=longlat +datum=WGS84")
  #sp_poly_df <- SpatialPolygonsDataFrame(sp_poly, data=data.frame(ID=1))
  #writeOGR(sp_poly_df, "chull", layer="chull", driver="ESRI Shapefile")
  
  vca <- intersect(v, respoly)
  spplot(vca, 'mean.psi', col.regions=rev(get_col_regions()))
  r <- raster(respoly, res=500)
  crs(r)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  crs(vca)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  vr <- rasterize(vca, r, 'mean.psi')
  crs(vr)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  plot(vr)
  points(dsp)
  
  writeRaster(vr,filename = paste0("U:/DataAnalysis/BreedingBirds/01132023predictions/",sppnames[i],"_detectmeanp_fulllandveg_origbbslocs_meandet.asc"),overwrite=TRUE)
  
  fitmax <- gstat::gstat(formula = mean.psi ~ 1, data = dsp, nmax = opt$par[1], set = list(idp = opt$par[2]))
  maxint <- raster::interpolate(r, model=fitmax)
  crs(maxint)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  plot(maxint, col=rev(heat.colors(255)))
  plot(vr, add=TRUE)
  r2 <- crop(maxint, extent(respoly))
  r3 <- mask(r2, respoly)
  idwrasters_detection[[i]]<-r3
  writeRaster(maxint,filename = paste0("U:/DataAnalysis/BreedingBirds/01132023predictions/",sppnames[i],"_detectmeanp_fulllandveg_origbbslocs_nni_opt_meandet.asc"),overwrite=TRUE)
  
}

saveRDS(idwrasters_detection,"G:/NaturalResources/Byer/datasets/BBS/idwrasters_fulllandveg_detection_meandet.Rdata")


```

### prediction overall all PCAP

```{r, eval = FALSE}
pcap_full<-read.csv("G:/NaturalResources/Byer/datasets/BBS/bbs_covariates.csv",header=T)

names(pcap_full)[names(pcap_full) == 'Plot.ID'] <- 'simp_plot'

pcap_full_land<-left_join(pcap_full,pcap_1styear_landscape,by="simp_plot")

pcap_full_land[is.na(pcap_full_land)] <- 0


monocots = (pcap_full_land$monocots - mean(bbs_occobject_three$occ.covs[, 20])) / sd(bbs_occobject_three$occ.covs[, 20])
perc_open = (pcap_full_land$percent_open - mean(bbs_occobject_three$occ.covs[, 21])) / sd(bbs_occobject_three$occ.covs[, 21])
developed.x = (pcap_full_land$developed.x - mean(bbs_occobject_three$occ.covs[, 11])) / sd(bbs_occobject_three$occ.covs[, 11])
ldi = (pcap_full_land$ldi_3k.x - mean(bbs_occobject_three$occ.covs[, 12])) / sd(bbs_occobject_three$occ.covs[, 12])
dicot = (pcap_full_land$dicot - mean(bbs_occobject_three$occ.covs[, 3])) / sd(bbs_occobject_three$occ.covs[, 3])
carex = (pcap_full_land$carex - mean(bbs_occobject_three$occ.covs[, 2])) / sd(bbs_occobject_three$occ.covs[, 2])
tolerant = (pcap_full_land$tolerant - mean(bbs_occobject_three$occ.covs[, 10])) / sd(bbs_occobject_three$occ.covs[, 10])
canopy_dens = (pcap_full_land$canopy_dens - mean(bbs_occobject_three$occ.covs[, 17])) / sd(bbs_occobject_three$occ.covs[, 17])
svp = (pcap_full_land$svp - mean(bbs_occobject_three$occ.covs[,7])) / sd(bbs_occobject_three$occ.covs[,7])

predict_data<-data.frame(int = 1, monocots = monocots, perc_open = perc_open, developed.x = developed.x,
                         ldi = ldi, dicot = dicot, carex = carex, tol_rel = tolerant, canopy_dens = canopy_dens, svp = svp)


fullpcappred<-predict(out.ms.landvegrda_2,as.matrix(predict_data))

RMSE <- function(observed, predicted) {
  sqrt(mean((predicted - observed)^2, na.rm=TRUE))
}
f1 <- function(x, test, train) {
  nmx <- x[1]
  idp <- x[2]
  if (nmx < 1) return(Inf)
  if (idp < .001) return(Inf)
  m <- gstat(formula=mean.psi~1, locations=train, nmax=nmx, set=list(idp=idp))
  p <- predict(m, newdata=test, debug.level=0)$var1.pred
  RMSE(test$mean.psi, p)
}

set.seed(12345)


respoly<-readOGR("G:/NaturalResources/Byer/DataAnalysis/bbs_cmp_analyses/bbsapp/CMPboundaries.shp")

fullpcaprasters<-list()

for(i in 1:length(sppnames)){
  plot.dat.ms <- data.frame(x = pcap_full_land$xcoord, 
                            y = pcap_full_land$ycoord, 
                            mean.psi = apply(fullpcappred$psi.0.samples[,i,], 2, mean),
                            sd.psi = apply(fullpcappred$psi.0.samples[,i,], 2, sd),
                            stringsAsFactors = FALSE)
  
  dsp <- SpatialPoints(plot.dat.ms[,1:2])
  dsp <- SpatialPointsDataFrame(dsp, plot.dat.ms)
  crs(dsp)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  j <- sample(nrow(dsp), 0.2 * nrow(dsp))
  tst <- dsp[j,]
  trn <- dsp[-j,]
  #opt <- optim(c(8, .5), f1, test=tst, train=trn)
  # define groups for mapping
  #cuts <- c(0,0.25,0.75,1.0)
  # set up a palette of interpolated colors
  #blues <- colorRampPalette(c('yellow', 'orange', 'blue', 'dark blue'))
  #spplot(dsp, 'mean.psi', cuts=cuts, col.regions=blues(5), pch=20, cex=2)
  #v <- voronoi(dsp)
  
  #ch <- chull(plot.dat.ms[,1:2])
  #coords <- plot.dat.ms[c(ch, ch[1]), 1:2]  # closed polygon
  
  #plot(plot.dat.ms[,1:2], pch=19)
  #lines(coords, col="#E69F00" )
  
 
  
  #sp_poly <- SpatialPolygons(list(Polygons(list(Polygon(coords)), ID=1)))
  # set coordinate reference system with SpatialPolygons(..., proj4string=CRS(...))
  # e.g. CRS("+proj=longlat +datum=WGS84")
  #sp_poly_df <- SpatialPolygonsDataFrame(sp_poly, data=data.frame(ID=1))
  #writeOGR(sp_poly_df, "chull", layer="chull", driver="ESRI Shapefile")
  
  #vca <- intersect(v, respoly)
  #spplot(vca, 'mean.psi', col.regions=rev(get_col_regions()))
  #r <- raster(respoly, res=500)
  #crs(r)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  #crs(vca)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  #vr <- rasterize(vca, r, 'mean.psi')
  #crs(vr)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  #plot(vr)
  #points(dsp)
  
  fitmax <- gstat::gstat(formula = mean.psi ~ 1, data = dsp, nmax = opt$par[1], set = list(idp = opt$par[2]))
  maxint <- raster::interpolate(r, model=fitmax)
  crs(maxint)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  plot(maxint, col=rev(heat.colors(255)))
  plot(vr, add=TRUE)
  r2 <- crop(maxint, extent(respoly))
  r3 <- mask(r2, respoly)
  fullpcaprasters[[i]]<-r3
  writeRaster(r3,filename = paste0("U:/DataAnalysis/BreedingBirds/01132023predictions/",sppnames[i],"_occmeanpsi_landvegrda_2_fullpcap_nni_opt_clipped.asc"),overwrite=TRUE)
  
}

saveRDS(fullpcaprasters,"G:/NaturalResources/Byer/datasets/BBS/fullpcaprasters_occ.Rdata")



#first import all files in a single folder as a list 
#rastlist <- list.files(path = "G:/NaturalResources/Byer/datasets/BBS/rasterpredictions/nni_opt/clipped", pattern='.asc$', 
#all.files=TRUE, full.names=TRUE)

#import all raster files in folder using lapply
#allrasters <- lapply(rastlist, raster)

#to check the index numbers of all imported raster list elements
#allrasters

#call single raster element
#allrasters[[1]]

#to run a function on an individual raster e.g., plot 
#plot(allrasters[[1]])

#saveRDS(allrasters,"G:/NaturalResources/Byer/datasets/BBS/rasterpredictions/nni_opt/clipped/nnirasters_fullpcap.RData")

rich.pred<-apply(fullpcappred$z.0.samples, c(1,3), sum)
rich.pred.R<-apply(fullpcappred$z.0.samples[,c(9,14,27,37,48,51,54,55,63,69,75,77,78,85,88,93,96),], c(1,3), sum)
rich.pred.S<-apply(fullpcappred$z.0.samples[,c(3,4,5,7,8,10,15,16,17,19,21,22,26,28,30,33,34,36,38,40,41,42,44,45,46,49,50,52,57,59,61,62,64,70,73,74,79,80,82,83,86,89,91,97,98),], c(1,3), sum)
rich.pred.T<-apply(fullpcappred$z.0.samples[,c(1,2,6,11,12,13,18,20,23,24,25,29,31,32,35,39,43,47,53,56,58,60,65,66,67,68,71,72,76,81,84,87,90,92,94,95,99,100,101,102,103),], c(1,3), sum)




 plot.dat.rich <- data.frame(x = pcap_full_land$xcoord, 
                            y = pcap_full_land$ycoord, 
                            mean.rich = apply(rich.pred, 2, mean),
                            sd.rich = apply(rich.pred, 2, sd),
                            mean.rich.R = apply(rich.pred.R,2,mean),
                            sd.rich.R = apply(rich.pred.R,2,sd),
                            mean.rich.S = apply(rich.pred.S,2,mean),
                            sd.rich.S = apply(rich.pred.S,2,sd),
                            mean.rich.T = apply(rich.pred.T,2,mean),
                            sd.rich.T = apply(rich.pred.T,2,sd),
                            stringsAsFactors = FALSE)
 
 write.csv(plot.dat.rich,"plotdatarichness.csv")
  
  dsp <- SpatialPoints(plot.dat.rich[,1:2])
  dsp <- SpatialPointsDataFrame(dsp, plot.dat.rich)
  crs(dsp)<-"+proj=lcc +lat_0=39.6666666666667 +lon_0=-82.5 +lat_1=41.7 +lat_2=40.4333333333333 +x_0=600000 +y_0=0 +datum=NAD83 +units=us-ft +no_defs"
  j <- sample(nrow(dsp), 0.2 * nrow(dsp))
  tst <- dsp[j,]
  trn <- dsp[-j,]
RMSE <- function(observed, predicted) {
  sqrt(mean((predicted - observed)^2, na.rm=TRUE))
}
f1 <- function(x, test, train) {
  nmx <- x[1]
  idp <- x[2]
  if (nmx < 1) return(Inf)
  if (idp < .001) return(Inf)
  m <- gstat(formula=mean.rich.S~1, locations=train, nmax=nmx, set=list(idp=idp))
  p <- predict(m, newdata=test, debug.level=0)$var1.pred
  RMSE(test$mean.rich.S, p)
}
p <- data.frame(geom(dsp)[, c("x", "y")], as.data.frame(dsp))
r <- raster(respoly, res=100)
opt <- optim(c(8, 0.5), f1, test=tst, train=trn)
m <- gstat(formula=mean.rich.S~1, locations=~x+y, data=p, nmax=opt$par[1], set=list(idp=opt$par[2]))
idw <- interpolate(r, m, debug.level=0)


idw <- mask(idw, respoly)
plot(idw, 1)

writeRaster(idw,filename = paste0(getwd(),"/Birdspprichness_S_idw_01312023.asc"),overwrite=TRUE)


```

### plotting using an RShiny app

While the below RShiny app should be fairly easy to use within the current webpage, you may also access this via: <https://testudinidude.shinyapps.io/bbsapp/>.

```{r, echo = FALSE,out.height="400%",out.width="150%"}
knitr::include_app("https://testudinidude.shinyapps.io/bbsapp/")
```

### covariate plotting

Finally, we can also run some plots depicting covariate effects for each species. These should make it clear if and when species appear to be particularly related to certain vegetative characteristics - and thus may serve as "indicators" for these characteristics.

```{r,fig.height=12,warning=FALSE,echo=FALSE,message=FALSE}
#options(max.print=1000000)
#sink("outmslandvegrda_2_90percent.txt")
#print(summary(out.ms.landvegrda_2,level="species",quantiles=c(0.05,0.5,0.95)))
#sink() 

covars<-read.csv("G:/NaturalResources/Byer/DataAnalysis/bbs_cmp_analyses/bbsapp/outmslandvegrda_4_90percent_sig_sppabbrev.csv",header=T)

covars_nodet<-covars[covars$Process == "Occupancy",]

covars_sig<-covars_nodet[covars_nodet$Sig == "YES",]

sppnames_sig<-unique(covars_sig$Species)

covars_nodet_sigspp<-covars_nodet[covars_nodet$Species %in% sppnames_sig,]

covars_monocots<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="monocots")

covars_monocots<-covars_monocots[order(covars_monocots$Mean),]

spp_monocotsorder<-factor(covars_monocots$Species,levels=covars_monocots$Species)

covars_monocots$spporder<-spp_monocotsorder

ggplot(aes(x=Mean,y=spp_monocotsorder),data=covars_monocots)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab(label="Effect of number of non-graminoid monocot species on occupancy")+ylab(label = NULL)+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 16,colour="black"),axis.text.x = element_text(size = 16,colour="black"),axis.title.x=element_text(size=20,colour="black"),axis.title.y=element_text(size=16,colour="black"))+scale_shape_manual(values=c(8,19))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none")

covars_perc_open<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="perc_open")

covars_perc_open<-covars_perc_open[order(covars_perc_open$Mean),]

spp_perc_open_order<-factor(covars_perc_open$Species,levels=covars_perc_open$Species)

covars_perc_open$spporder<-spp_perc_open_order

ggplot(aes(x=Mean,y=spp_perc_open_order),data=covars_perc_open)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Effect of percent open canopy cover on occupancy")+ylab(NULL)+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 16,colour="black"),axis.text.x = element_text(size = 14,colour="black"),axis.title.x=element_text(size=20,colour="black"),axis.title.y=element_text(size=16,colour="black"))+scale_shape_manual(values=c(8,19))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 

covars_developed<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="developed.x")

covars_developed<-covars_developed[order(covars_developed$Mean),]

spp_devorder<-factor(covars_developed$Species,levels=covars_developed$Species)

covars_developed$spporder<-spp_devorder

ggplot(aes(x=Mean,y=spp_devorder),data=covars_developed)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Effect of distance to developed land cover on occupancy")+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 12))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none")    

covars_ldi<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="ldi")

covars_ldi<-covars_ldi[order(covars_ldi$Mean),]

spp_ldiorder<-factor(covars_ldi$Species,levels=covars_ldi$Species)

covars_ldi$spporder<-spp_ldiorder

ggplot(aes(x=Mean,y=spp_ldiorder),data=covars_ldi)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic()+xlab("Effect of landscape development index on occupancy")+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 8))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none")     

covars_dicot<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="dicot")

covars_dicot<-covars_dicot[order(covars_dicot$Mean),]

spp_dicotorder<-factor(covars_dicot$Species,levels=covars_dicot$Species)

covars_dicot$spporder<-spp_dicotorder

ggplot(aes(x=Mean,y=spp_dicotorder),data=covars_dicot)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Effect of number of dicot species on occupancy")+ylab(NULL)+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 16,colour="black"),axis.text.x = element_text(size = 14,colour="black"),axis.title.x=element_text(size=20,colour="black"),axis.title.y=element_text(size=16,colour="black"))+scale_shape_manual(values=c(8,19))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 


covars_carex<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="carex")

covars_carex<-covars_carex[order(covars_carex$Mean),]

spp_carexorder<-factor(covars_carex$Species,levels=covars_carex$Species)

covars_carex$spporder<-spp_carexorder

ggplot(aes(x=Mean,y=spp_carexorder),data=covars_carex)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic()+xlab(expression(paste("Effect of number of ",italic("Carex"),"species on occupancy")))+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 8))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 


covars_tolerance<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="tol_rel")

covars_tolerance<-covars_tolerance[order(covars_tolerance$Mean),]

spp_tolorder<-factor(covars_tolerance$Species,levels=covars_tolerance$Species)

covars_tolerance$spporder<-spp_tolorder

ggplot(aes(x=Mean,y=spp_tolorder),data=covars_tolerance)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic()+xlab("Effect of relative cover of tolerant plant species on occupancy")+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 8))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 


covars_canopy_dens<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="canopy_dens")

covars_canopy_dens<-covars_canopy_dens[order(covars_canopy_dens$Mean),]

spp_canopy_dens_order<-factor(covars_canopy_dens$Species,levels=covars_canopy_dens$Species)

covars_canopy_dens$spporder<-spp_canopy_dens_order

ggplot(aes(x=Mean,y=spp_canopy_dens_order),data=covars_canopy_dens)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic()+xlab("Effect of the number of canopy tree stems on occupancy")+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 8))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 



covars_svp<-subset(covars_nodet_sigspp,covars_nodet_sigspp$Covariate=="svp")

covars_svp<-covars_svp[order(covars_svp$Mean),]

spp_svporder<-factor(covars_svp$Species,levels=covars_svp$Species)

covars_svp$spporder<-spp_svporder

ggplot(aes(x=Mean,y=spp_svporder),data=covars_svp)+geom_point(aes(pch=Sig,color=Migratory),size=6)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic()+xlab("Effect of number of seedless vascular plant species on occupancy")+ylab("Species code")+geom_vline(xintercept = 0) + theme(axis.text.y = element_text(size = 8))+scale_shape_manual(values=c(20,8))+scale_color_manual(values=c("#E69F00" ,"#009E73","#56B4E9"))+theme(legend.position="none") 

```

### just plotting a few focal species

```{r,fig.height=12,warning=FALSE,echo=FALSE,message=FALSE}
#options(max.print=1000000)
#sink("outmsfulllandveg_90percent_comm.txt")
#print(summary(out.ms.landvegrda_2,level="community",quantiles=c(0.05,0.5,0.95)))
#sink() 

covars<-read.csv("G:/NaturalResources/Byer/DataAnalysis/bbs_cmp_analyses/bbsapp/outmslandvegrda_2_90percent_sig.csv",header=T)

covars_foc<-covars[covars$Species %in% c("Acadian Flycatcher","Hooded Warbler","Pileated Woodpecker","Song Sparrow"),]

covars_ldi<-subset(covars_foc,covars_foc$Covariate=="ldi")

covars_ldi<-covars_ldi[order(covars_ldi$Mean),]

spp_ldiorder<-factor(covars_ldi$Species,levels=sort(covars_ldi$Species,decreasing = TRUE))

covars_ldi$spporder<-spp_ldiorder

ggplot(aes(x=Mean,y=spp_ldiorder),data=covars_ldi)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate - occupancy")+ylab("Landscape development index")

covars_distroad<-subset(covars_foc,covars_foc$Covariate=="dist_road")

covars_distroad<-covars_distroad[order(covars_distroad$Mean),]

spp_roadorder<-factor(covars_distroad$Species,levels=covars_distroad$Species)

covars_distroad$spporder<-spp_roadorder

ggplot(aes(x=Mean,y=spp_roadorder),data=covars_distroad)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=12)+xlab("Covariate estimate - detection")+ylab("Distance to roads")


covars_intercept<-subset(covars_foc,covars_foc$Covariate=="Intercept")

covars_detect_intercept<-subset(covars_intercept,covars_intercept$Process=="Detection")

covars_detect_intercept<-covars_detect_intercept[order(covars_detect_intercept$Mean),]

spp_detectorder<-factor(covars_detect_intercept$Species,levels=sort(covars_detect_intercept$Species,decreasing=TRUE))

covars_detect_intercept$spporder<-spp_detectorder

ggplot(aes(x=Mean,y=spporder),data=covars_detect_intercept)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=12)+xlab("Covariate estimate")+ylab("detection intercept")




covars_developed<-subset(covars_foc,covars_foc$Covariate=="developed.x")

covars_developed<-covars_developed[order(covars_developed$Mean),]

spp_tolorder<-factor(covars_developed$Species,levels=sort(covars_developed$Species,decreasing=TRUE))

covars_developed$spporder<-spp_tolorder

ggplot(aes(x=Mean,y=spp_tolorder),data=covars_developed)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate")+ylab("developed")


covars_tolerance<-subset(covars_foc,covars_foc$Covariate=="tol_rel")

covars_tolerance<-covars_tolerance[order(covars_tolerance$Mean),]

spp_tolorder<-factor(covars_tolerance$Species,levels=sort(covars_tolerance$Species,decreasing=TRUE))

covars_tolerance$spporder<-spp_tolorder

ggplot(aes(x=Mean,y=spp_tolorder),data=covars_tolerance)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate")+ylab("Relative cover of tolerant plants")


covars_svp<-subset(covars_foc,covars_foc$Covariate=="svp")

covars_svp<-covars_svp[order(covars_svp$Mean),]


spp_svporder<-factor(covars_svp$Species,levels=covars_svp$Species)

covars_svp$spporder<-spp_svporder

ggplot(aes(x=Mean,y=spp_svporder),data=covars_svp)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=12)+xlab("Covariate estimate")+ylab("Cover of seedless vascular plants")


covars_dicot<-subset(covars_foc,covars_foc$Covariate=="dicot")

covars_dicot<-covars_dicot[order(covars_dicot$Mean),]


spp_dicotorder<-factor(covars_dicot$Species,levels=covars_dicot$Species)

covars_dicot$spporder<-spp_dicotorder

ggplot(aes(x=Mean,y=spp_dicotorder),data=covars_dicot)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=12)+xlab("Covariate estimate")+ylab("Cover of dicots")


covars_cyper<-subset(covars_foc,covars_foc$Covariate=="cyper")

covars_cyper<-covars_cyper[order(covars_cyper$Mean),]


spp_cyperorder<-factor(covars_cyper$Species,levels=covars_cyper$Species)

covars_cyper$spporder<-spp_cyperorder

ggplot(aes(x=Mean,y=spp_cyperorder),data=covars_cyper)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=12)+xlab("Covariate estimate")+ylab("Cover of sedges")


```

# community-level plotting

```{r}
covars_comm<-read.csv("G:/NaturalResources/Byer/DataAnalysis/bbs_cmp_analyses/bbsapp/outmslandvegrda_3_90percent_comm.csv")

ggplot(aes(x=Mean,y=factor(Covariate,levels=Covariate)),data=covars_comm)+geom_point(size=3)+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate")+ylab("Covariates") + geom_vline(xintercept=0)+geom_point(aes(x=Mean_S),color="#009E73",size=3)+
geom_point(aes(x=Mean_T),color="#56B4E9",size=3)+geom_point(aes(x=Mean_R),color="#E69F00" ,size=3)

```
<<<<<<<< HEAD:bbs_cmp_bin_sub.Rmd
========


# influences of migratory status

```{r}
ggplot(aes(x=Mean,y=factor(Covariate,levels=Covariate),fill=Migratory),data=covars)+geom_point()+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate")+ylab("Covariates") + geom_vline(xintercept=0)


covars_ldi<-subset(covars_foc,covars_foc$Covariate=="ldi")

covars_ldi<-covars_ldi[order(covars_ldi$Mean),]

spp_ldiorder<-factor(covars_ldi$Species,levels=sort(covars_ldi$Species,decreasing = TRUE))

covars_ldi$spporder<-spp_ldiorder

ggplot(aes(x=Mean,y=Covariate),data=covars)+stat_summary(aes(group=Migratory))+geom_errorbarh(aes(xmin=X5.,xmax=X95.))+theme_classic(base_size=16)+xlab("Covariate estimate - occupancy")+ylab("Landscape development index")
```
>>>>>>>> 428d11ca61457c1db8950a8dfc5b38d9906569b4:bbs_cmp_bin.Rmd
